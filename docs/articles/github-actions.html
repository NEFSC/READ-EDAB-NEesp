<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/3/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>Creating reports with Github Actions • NEesp</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/3/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/3/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
<!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating reports with Github Actions">
<meta property="og:description" content="NEesp">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NEesp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/install-and-use-package.html">Install and use package</a>
    </li>
    <li>
      <a href="../articles/shiny-app.html">Use NEesp with the NEespShiny app</a>
    </li>
    <li>
      <a href="../articles/data.html">Data in NEesp</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    About ESP
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/why-esp.html">Why ESP?</a>
    </li>
    <li>
      <a href="../articles/risk-assessment.html">Creating the risk assessment</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Report writing methods
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rmarkdown-intro.html">Intro to RMarkdown for report writing</a>
    </li>
    <li>
      <a href="../articles/general-workflow.html">General report creation workflow</a>
    </li>
    <li>
      <a href="../articles/bookdown-templates.html">About report templates</a>
    </li>
    <li>
      <a href="../articles/indicator-template.html">The indicator report template</a>
    </li>
    <li>
      <a href="../articles/correlation-template.html">The correlation report template</a>
    </li>
    <li>
      <a href="../articles/github-actions.html">Creating reports with Github Actions</a>
    </li>
    <li>
      <a href="../articles/cache-guide.html">How to cache with Github Actions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../mailto:abigail.tyrell@noaa.gov">
    <span class="fas fa-paper-plane fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/NOAA-EDAB/NEesp/issues/">
    <span class="fas fa-question-circle fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/NOAA-EDAB/NEesp">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://nmfs-general-modeling-tools.github.io/">
    <span class="fas fa-fish"></span>
     
  </a>
</li>
        
        


      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="github-actions_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Creating reports with Github Actions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NOAA-EDAB/NEesp/blob/master/vignettes/github-actions.Rmd"><code>vignettes/github-actions.Rmd</code></a></small>
      <div class="hidden name"><code>github-actions.Rmd</code></div>

    </div>

    
    
<div id="intro-to-github-actions" class="section level2">
<h2 class="hasAnchor">
<a href="#intro-to-github-actions" class="anchor"></a>Intro to Github Actions</h2>
<p><a href="https://github.com/features/actions">Github Actions</a> allow you to run code remotely. Following instructions written in <a href="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html">YAML syntax</a>, a remote Github runner executes code. There are hundreds of existing Github Actions workflows that can help you accomplish nearly any (automatable) task, such as performing standard tests, re-deploying a pkgdown website when vignettes are updated, or rendering reports from a template.</p>
</div>
<div id="workflow-overview" class="section level2">
<h2 class="hasAnchor">
<a href="#workflow-overview" class="anchor"></a>Workflow overview</h2>
<p>To use Github Actions to create reports, there are three general steps:</p>
<ol style="list-style-type: decimal">
<li>Set up the remote environment. Because the code is running in a remote environment, everything that your code needs has to be explicitly added. Fortunately, there are existing Actions that you can use to do most of these steps.</li>
</ol>
<ul>
<li>Checkout your repo</li>
<li>Install all necessary programs and load necessary R packages</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Create your reports</li>
</ol>
<ul>
<li>Run a script to create the reports</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Deploy your reports to Github In order for your newly created reports to get off of the remote runner and accessible on github.com, you need to deploy the reports. They can be deployed an any branch on any repository that you own.</li>
</ol>
<ul>
<li>Deploy your reports to a Github repo</li>
</ul>
</div>
<div id="detailed-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#detailed-workflow" class="anchor"></a>Detailed workflow</h2>
<p>This section walks through the guts of the <a href="https://github.com/NOAA-EDAB/esp_data_aggregation/blob/abby/.github/workflows/render_indicator_reports_dev.yaml">YAML file that is used to create NEesp reports</a>. This workflow not only deploys the reports to Github, it also handles errors within the report and creates an error summary for troubleshooting.</p>
<p>One important thing to know about YAMLs is that <strong>indentation and colons matter</strong>. If there is a problem with your YAML file, it is almost certainly an issue with indentation and/or colon placement. Using the tab key to create indentations can cause problems.</p>
<div id="specify-the-workflow-trigger" class="section level3">
<h3 class="hasAnchor">
<a href="#specify-the-workflow-trigger" class="anchor"></a>Specify the workflow trigger</h3>
<p>First, the trigger for the workflow must be specified.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">workflow_dispatch</span><span class="kw">:</span></span></code></pre></div>
<p><code>workflow_dispatch</code> means that the workflow is triggered manually on the Actions page of the repo. Workflows can also be triggered by pushes and pulls to the repository.</p>
</div>
<div id="name-the-workflow-optional" class="section level3">
<h3 class="hasAnchor">
<a href="#name-the-workflow-optional" class="anchor"></a>Name the workflow (optional)</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Indicator Reports (development)</span></span></code></pre></div>
</div>
<div id="specify-the-envorinment-for-your-job" class="section level3">
<h3 class="hasAnchor">
<a href="#specify-the-envorinment-for-your-job" class="anchor"></a>Specify the envorinment for your job</h3>
<p>Your workflow can run on Linux, Windows, or Mac. This can be useful if you require a package or method that is only available on a certain operating system. You can also set environment secrets, for example in this workflow a password is set to give permission to the deployment step, and <code>R_REMOTES_NO_ERRORS_FROM_WARNINGS</code> is set to <code>true</code> to prevent the workflow from failing if the R script throws a warning.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build1</span><span class="kw">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">GITHUB_PAT</span><span class="kw">:</span><span class="at"> ${{ secrets.GH_PAT }}</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">R_REMOTES_NO_ERRORS_FROM_WARNINGS</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span></code></pre></div>
</div>
<div id="add-steps-to-your-jobs" class="section level3">
<h3 class="hasAnchor">
<a href="#add-steps-to-your-jobs" class="anchor"></a>Add steps to your job(s)</h3>
<p>This is the backbone of your workflow. The steps will run in sequence. It is possible to run multiple jobs in parallel, but each job must have all of the necessary set-up steps, so this parallelization does not typically save a notable amount of time when rendering reports. Additionally, if two jobs attempt to deploy reports at the same time, one of them will typically fail.</p>
<div id="checkout-your-repository" class="section level4">
<h4 class="hasAnchor">
<a href="#checkout-your-repository" class="anchor"></a>1. Checkout your repository</h4>
<p>This step is necessary to get the information from your repository onto the remote runner.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="at">          </span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout esp_data_aggregation</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">persist-credentials</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span></code></pre></div>
</div>
<div id="install-pandoc" class="section level4">
<h4 class="hasAnchor">
<a href="#install-pandoc" class="anchor"></a>2. Install Pandoc</h4>
<p>Pandoc is used under the hood by the <code>knitr</code>, <code>bookdown</code>, and <code>rmarkdown</code> suite of report rendering functions.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install Pandoc</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> brew install pandoc</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash</span></span></code></pre></div>
</div>
<div id="install-command-line-packages" class="section level4">
<h4 class="hasAnchor">
<a href="#install-command-line-packages" class="anchor"></a>3. Install command line packages</h4>
<p>Some R libraries may require command line updates to install or update back-end packages.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install command line packages</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span><span class="at">        </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>          sudo apt update</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>          sudo apt-get install  libgdal-dev libcurl4-gnutls-dev libgit2-dev libudunits2-dev</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash</span></span></code></pre></div>
</div>
<div id="install-r" class="section level4">
<h4 class="hasAnchor">
<a href="#install-r" class="anchor"></a>4. Install R</h4>
<p>R must be installed on the remote runner!</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up R</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/setup-r@master</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">r-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'4.0.3'</span><span class="co"> # problem with using 4.0.4        </span></span></code></pre></div>
</div>
<div id="cache-your-r-packages" class="section level4">
<h4 class="hasAnchor">
<a href="#cache-your-r-packages" class="anchor"></a>5. Cache your R packages</h4>
<p>If your reports depend on a large number of R packages, it will save a lot of time in the long run to cache the packages.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Cache R packages</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/cache@v2</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> cache</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> ${{ env.R_LIBS_USER }}</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">key</span><span class="kw">:</span><span class="at"> bigger-cache-more-packages-05192021-AT</span></span></code></pre></div>
</div>
<div id="update-packages-if-needed" class="section level4">
<h4 class="hasAnchor">
<a href="#update-packages-if-needed" class="anchor"></a>6. Update packages if needed</h4>
<p>It doesn’t always make sense, but sometimes a package needs to be re-installed to work correctly - possible an old version was in the cache. In this case, the <code>sf</code> package needs to be re-installed.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Re-install sf</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>          Rscript -e '</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>          remove.packages("sf")</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>          install.packages("sf")'</span></code></pre></div>
</div>
<div id="render-your-reports" class="section level4">
<h4 class="hasAnchor">
<a href="#render-your-reports" class="anchor"></a>7. Render your reports</h4>
<p>This script is calling <a href="https://github.com/NOAA-EDAB/esp_data_aggregation/blob/abby/R-scripts/render%20dev%20report%20with%20errors.R">another script</a> to render the reports, to avoid having to write a large amount of R code in the YAML file.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Render reports</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>          Rscript -e '</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>          # install dev NEesp</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>          remove.packages("NEesp")</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>          remotes::install_github("NOAA-EDAB/NEesp", ref = "dev", upgrade = "never")</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>          # create reports</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>          species &lt;- NEesp::species_key$Species</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>          source(here::here("R-scripts", "render dev report with errors.R"))'</span></code></pre></div>
<hr>
<div id="the-rendering-script" class="section level5">
<h5 class="hasAnchor">
<a href="#the-rendering-script" class="anchor"></a>The rendering script</h5>
<p>The script begins with set-up: loading <code>%&gt;%</code> and setting a null <code>output</code> object that will be filled later in the script.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">`%&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va">`%&gt;%`</span>
<span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><code>suppressWarnings</code> silences much of the script output, making the Github Actions log easier to read.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>({</span></code></pre></div>
<p>The <code>species</code> variable was set in the YAML, and it is a vector of species names. That way the species can be altered without changing the rendering script.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> species) {</span></code></pre></div>
<p><code>sink</code> is used to hide the unnecessary script output. <code>hide.txt</code> is a garbage file that will be deleted later.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="fu"><a href="https://rdrr.io/r/base/sink.html">sink</a></span><span class="op">(</span><span class="st">"hide.txt"</span><span class="op">)</span></code></pre></div>
<p>The report rendering is wrapped in <code>try</code> so that if a report breaks, the script will continue to the next species instead of ending on an error. Assigning the report rendering function to a variable does not affect the report creation or saving.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">test</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu">NEesp</span><span class="fu">::</span><span class="fu"><a href="../reference/render_ind_report.html">render_ind_report</a></span><span class="op">(</span><span class="va">i</span>,
      input <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"bookdown"</span><span class="op">)</span>,
      params_to_use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        species_ID <span class="op">=</span> <span class="va">i</span>,
        ricky_survey_data <span class="op">=</span> <span class="fu">NEesp</span><span class="fu">::</span><span class="va"><a href="../reference/bio_survey.html">bio_survey</a></span>,
        path <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"action_reports"</span>, <span class="va">i</span>, <span class="st">"figures//"</span><span class="op">)</span>,
        save <span class="op">=</span> <span class="cn">TRUE</span>
      <span class="op">)</span>, trouble <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If report rendering failed, the script searches for which file caused the problem.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">class</span>(test) <span class="sc">==</span> <span class="st">"try-error"</span>) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>      problem_file <span class="ot">&lt;-</span> NEesp<span class="sc">::</span><span class="fu">find_files</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">{r"</span>, <span class="st">"(.{1,5})"</span>, chunk_name),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"bookdown"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> <span class="fu">invisible</span>()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      problem_file <span class="ot">&lt;-</span> problem_file <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        tibble<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(file, <span class="st">"not-used"</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<style>
div.blue body { background-color:aliceblue; }
div.blue code { background-color:aliceblue; }
div.blue pre.r { background-color:aliceblue; }
</style>
<div class="blue">
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">### keeping track of code chunks </span><span class="al">###</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">chunk_name</span><span class="st">`</span> is a variable created by the Rmarkdown template. Using a <span class="st">`</span><span class="at">knitr</span><span class="st">`</span> <span class="fu">hook</span> (code below), </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">chunk_name</span><span class="st">`</span> is dynamically updated to the name of the current chunk being <span class="fu">rendered</span> (the name of the </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>chunk containing the setup hook must be manually specified). The <span class="st">`</span><span class="at">&lt;&lt;-</span><span class="st">`</span> assignment operator creates a </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>variable <span class="cf">in</span> the global environment during report rendering. <span class="st">`</span><span class="at">last_known</span><span class="st">`</span> is another variable that tracks </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>the name of the last named chunk; it is useful because not all chunks have names.</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>last_known <span class="ot">&lt;&lt;-</span> <span class="st">'setup'</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>knit_hooks<span class="sc">$</span><span class="fu">set</span>(<span class="at">hook_name =</span> <span class="cf">function</span>(before){</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(before){</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    chunk_name <span class="ot">&lt;&lt;-</span> knitr<span class="sc">::</span>opts_current<span class="sc">$</span><span class="fu">get</span>()<span class="sc">$</span>label</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    known_name <span class="ot">=</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(chunk_name, <span class="st">'unnamed-chunk-'</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(known_name) {</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>      last_known <span class="ot">&lt;&lt;-</span> chunk_name</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
<p>If the script can’t find the file that caused the problem, that means that <code>chunk_name</code> isn’t in any of the template files. In turn, that means that the chunk that caused the problem was an unnamed chunk, so it was automatically assigned a name during rendering, which of course cannot be found in the template file. In this situation, the script searches for and displays the name of the last named chunk instead.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (problem_file <span class="sc">==</span> <span class="st">"Not found"</span>) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>        problem_file2 <span class="ot">&lt;-</span> NEesp<span class="sc">::</span><span class="fu">find_files</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">{r"</span>, <span class="st">"(.{1,5})"</span>, last_known),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>          here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"bookdown"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> <span class="fu">invisible</span>()</span></code></pre></div>
<p>Files that are in the template folder but are not used in report creation are in a <code>not-used</code> folder so they can be filtered out from the troubleshooting.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R">        <span class="va">problem_file2</span> <span class="op">&lt;-</span> <span class="va">problem_file2</span> <span class="op">%&gt;%</span>
          <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">file</span>, <span class="st">"not-used"</span>, negate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

        <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="va">problem_file2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">%&gt;%</span>
          <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="st">"bookdown/"</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
        <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="va">file_name</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></code></pre></div>
<p>Diagnostic output of the last known file, chunk name, and line run are generated.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>        this_output <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>          i, test[<span class="dv">1</span>],</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">paste</span>(<span class="st">"unknown - last known file:"</span>, file_name),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>          chunk_name,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">paste</span>(<span class="st">"unknown - last known line:"</span>, problem_file2[<span class="dv">2</span>])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span> <span class="cf">else</span> {</span></code></pre></div>
<p>If the chunk name of the problem code is known, the analysis is simpler. Diagnostic output of the last known file, chunk name, and line run are generated.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>        problem_file <span class="ot">&lt;-</span> problem_file <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>          tibble<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(file, <span class="st">"not-used"</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        file_name <span class="ot">&lt;-</span> problem_file[, <span class="dv">1</span>] <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>          stringr<span class="sc">::</span><span class="fu">str_split</span>(<span class="st">"bookdown/"</span>, <span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        file_name <span class="ot">&lt;-</span> file_name[[<span class="dv">1</span>]][<span class="dv">2</span>]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        this_output <span class="ot">&lt;-</span> <span class="fu">c</span>(i, <span class="fu">toString</span>(test[<span class="dv">1</span>]), file_name, chunk_name, problem_file[, <span class="dv">2</span>],</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span></code></pre></div>
<p>The output is appended to the <code>output</code> object to keep an error log, and the script reports that it has finished a species.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>      output <span class="ot">&lt;-</span> <span class="fu">rbind</span>(output, this_output)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sink</span>()</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Done with"</span>, i))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span></code></pre></div>
<p>If the report rendered successfully for all species, <code>output</code> is still a null object at the end of the <code>for</code> loop. In order to satisfy the requirements of the deployment step, an empty folder called <code>logs</code> is created.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">class</span>(output) <span class="sc">==</span> <span class="st">"NULL"</span>) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"logs"</span>))</span></code></pre></div>
<p>If the <code>output</code> object is not a null object, that means that one or more species reports had errors. <code>output</code> is saved as a spreadsheet in the <code>logs</code> folder.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span> <span class="cf">else</span> {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(output) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Species"</span>, <span class="st">"Error"</span>, <span class="st">"File throwing error"</span>, <span class="st">"Chunk name"</span>, <span class="st">"Line throwing error"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"logs/"</span>, <span class="fu">Sys.time</span>(), <span class="st">".csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">":"</span>, <span class="st">"."</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"logs"</span>))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(output, here<span class="sc">::</span><span class="fu">here</span>(file), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>If the reports that did not render successfully, some files did not get properly cleaned up, so this step removes those files.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># clean up .Rmd and .yml files that didn't render</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    files_to_remove <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">list.files</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"action_reports"</span>), </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.Rmd$"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">recursive =</span> <span class="cn">TRUE</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">full.names =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">list.files</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"action_reports"</span>), </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.yml$"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">recursive =</span> <span class="cn">TRUE</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(files_to_remove)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="er">})</span></span></code></pre></div>
<p>And that’s the end of the report rendering script!</p>
<hr>
</div>
</div>
<div id="downsize-images-to-save-space-optional" class="section level4">
<h4 class="hasAnchor">
<a href="#downsize-images-to-save-space-optional" class="anchor"></a>8. Downsize images to save space (optional)</h4>
<p>The default linux runner creates .png images with 24-bit color depth, which take up a lot of space and aren’t necessary to achieve adequate image quality. Therefore, this step downgrades the images to 8-bit, and displays the folder size before and after downsizing.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Change images to 8-bit</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>          sudo apt-get install -y pngquant</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>          cd action_reports</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>          du -s</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>          pngquant --quality=0-90 --force --ext .png */*/*.png</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>          du -s</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash </span></span></code></pre></div>
</div>
<div id="compress-images-to-save-space-optional" class="section level4">
<h4 class="hasAnchor">
<a href="#compress-images-to-save-space-optional" class="anchor"></a>9. Compress images to save space (optional)</h4>
<p>.png images are further compressed to save space. Folders not associated with the creation of these reports are ignored.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Compress Images</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> calibre</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> calibreapp/image-actions@main</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">githubToken</span><span class="kw">:</span><span class="at"> ${{ secrets.GH_PAT }}</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ignorePaths</span><span class="kw">:</span><span class="at"> </span><span class="st">'Regression_reports/**, black-sea-bass/**, R-scripts/**'</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">compressOnly</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code></pre></div>
</div>
<div id="check-directory-size-optional" class="section level4">
<h4 class="hasAnchor">
<a href="#check-directory-size-optional" class="anchor"></a>10. Check directory size (optional)</h4>
<p>The size of the folder containing the reports is displayed. If it is over 2GB, it cannot be deloyed to Github in one chunk.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Check directory size</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>          cd action_reports</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>          du -s</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash          </span></span></code></pre></div>
</div>
<div id="deploy-the-reports-to-github" class="section level4">
<h4 class="hasAnchor">
<a href="#deploy-the-reports-to-github" class="anchor"></a>11. Deploy the reports to Github</h4>
<p>The <code>action_reports</code> folder containing the reports is deployed to Github.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy reports to Github</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> JamesIves/github-pages-deploy-action@4.1.1</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">repository-name</span><span class="kw">:</span><span class="at"> NOAA-EDAB/ESP_docs</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">token</span><span class="kw">:</span><span class="at"> ${{ secrets.GH_PAT }}</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">branch</span><span class="kw">:</span><span class="at"> main</span><span class="co"> # The branch the action should deploy to.</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">folder</span><span class="kw">:</span><span class="at"> action_reports</span><span class="co"> # The folder the action should deploy.</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">target-folder</span><span class="kw">:</span><span class="at"> Reports</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">clean</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span><span class="co"> # Automatically remove deleted files from the deploy branch</span></span></code></pre></div>
</div>
<div id="deploy-the-status-check-to-github" class="section level4">
<h4 class="hasAnchor">
<a href="#deploy-the-status-check-to-github" class="anchor"></a>12. Deploy the status check to Github</h4>
<p>The <code>logs</code> folder containing the error logs is deployed to Github. If there were no errors in report creation, this step is skipped because there is no file to deploy.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy status check to Github</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> logdeploy</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> JamesIves/github-pages-deploy-action@4.1.1</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">token</span><span class="kw">:</span><span class="at"> ${{ secrets.GH_PAT }}</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">branch</span><span class="kw">:</span><span class="at"> main</span><span class="co"> # The branch the action should deploy to.</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">folder</span><span class="kw">:</span><span class="at"> logs</span><span class="co"> # The folder the action should deploy.</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">target-folder</span><span class="kw">:</span><span class="at"> logs</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">clean</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span><span class="co"> # Automatically remove deleted files from the deploy branch</span></span></code></pre></div>
</div>
<div id="create-an-issue-if-the-status-check-showed-errors" class="section level4">
<h4 class="hasAnchor">
<a href="#create-an-issue-if-the-status-check-showed-errors" class="anchor"></a>13. Create an issue if the status check showed errors</h4>
<p>If the <code>logs</code> folder deployment was not skipped (meaning that there were errors), an issue is created. The issue uses <a href="https://github.com/NOAA-EDAB/esp_data_aggregation/blob/abby/.github/ISSUE_TEMPLATE.md">this template</a>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Create issue (if needed)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">if</span><span class="kw">:</span><span class="at"> ${{ env.deployment_status != 'skipped' }}</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> JasonEtco/create-an-issue@v2</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">GITHUB_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.GH_PAT }}</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">assignees</span><span class="kw">:</span><span class="at"> ${{ env.GITHUB_ACTOR }}</span></span></code></pre></div>
</div>
<div id="force-the-workflow-to-break-if-the-status-check-showed-errors" class="section level4">
<h4 class="hasAnchor">
<a href="#force-the-workflow-to-break-if-the-status-check-showed-errors" class="anchor"></a>14. Force the workflow to break if the status check showed errors</h4>
<p>If the <code>logs</code> folder deployment was not skipped (meaning that there were errors), the workflow is stopped with an error message.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Status</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>          Rscript -e '</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>          if (quote(${{ env.deployment_status }}) == "skipped"){</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>          "Passing!"</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>          } else { </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>          stop("Errors found! Check logs folder.") </span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>          }'</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/atyrell3">Abigail Tyrell</a>, <a href="https://github.com/rtabandera">Ricky Tabandera</a>.</p>
</div>

<div class="pkgdown">
  <p>Made with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1, using <a href="https://preferably.amirmasoudabdol.name/?source=footer">preferably</a> template.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
