---
author: "Ricky Tabandera"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: html_document
params:
  stock:
    label: "Stock:"
    value: black sea bass
    input: select
    choices: [haddock, yellowtail flounder, atlantic cod,  red hake, pollock, scup, alewife, silver hake, atlantic mackerel, acadian redfish, winter flounder, summer flounder, american plaice, witch flounder, butterfish, white hake, blueback herring, black sea bass,   bluefish, atlantic herring,  ocean pout, monkfish,  little skate, winter skate,  windowpane flounder,  thorny skate, atlantic wolffish, cusk,   atlantic halibut, clearnose skate, smooth skate, offshore hake,  rosette skate,  barndoor skate, spiny dogfish, american lobster, smooth dogfish,  atlantic menhaden, longfin inshore squid, atlantic hagfish, northern shortfin squid ]
  
title: "Age diversity of `r stringr::str_to_sentence(params$stock)`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(survdat))
suppressPackageStartupMessages(library(dbutils))


```


```{r data wrangling, echo=FALSE, message=FALSE, error=FALSE}
#load survdat 
survdata<-readRDS(here::here("survdat_pull_bio.rds"))
#change from char to numeric
survdata<-survdata %>% mutate(SVSPP=as.numeric(SVSPP))
#load ECSA data with common names 
stock_list_all_strata <- read.csv("https://raw.githubusercontent.com/NOAA-EDAB/ECSA/master/data/stock_list.csv")
stock_list_all_strata<-stock_list_all_strata %>% rename(SVSPP=svspp)
stock_list<-stock_list_all_strata %>% dplyr::distinct(SVSPP,.keep_all =T)
#link common names to  this dataset 
survdata.w.codes<-inner_join(survdata, stock_list, by= "SVSPP" )
#filter down to a single stock 
selected.spp<- survdata.w.codes %>% filter(common_name==params$stock)



```

## Age diversity 

Diversity in age measurements of a stock is a useful indicator of several factors relating to fishing pressure and recruitment. A decrease in diversity can be due to either truncation, the lack of older or younger ages. Diversity changes as a funtion of an increase of a single/few ages relative to the usual stock age structure or as more ages become less reprisented. Diagnostic plots of age are constructed below using fisheries independent data from Survdata.

`r if(params$stock == "monkfish"){"The age determination method for monkfish has not been validated, and the anatomic structure used has changed through time. In addition these stocks display a high degree of sexual dimorphisms making fitting of single growth curves unreliable.  This results a high degree of uncertainty in assessing the age structure of the stock and the effects of fishing pressure."}`


```{r, age diversity calculations, echo= FALSE, message=FALSE, error=FALSE}

selected.age<- selected.spp %>% filter(!is.na(AGE))

age.freq<-selected.age %>% 
      group_by(YEAR, AGE)%>%
      summarise(age.n=n())
age.freq<-age.freq %>% group_by(YEAR) %>% mutate(prop=(age.n/sum(age.n))) %>% mutate(prop.ln=(prop*log(prop)))  


age.freq<-age.freq %>% group_by(YEAR) %>% summarise(shanon.h=(-1*(sum(prop.ln))))          

age.freq %>%
  ggplot(aes(x=YEAR,y=shanon.h))+
  geom_path(group = 1, size=1.2, color="blue")+
  geom_point(size=3, shape=23, fill="Black")+
  xlab("Year")+
  ylab("Shannon diversity index (H)")+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle("Age diversity of", subtitle =params$stock )
                                               
                                               
```




## Density plots of age

Age distribution across years of survey data of `r params$stock`. These plots can help identify strong year classes of recruits and how these classes persist in the fishery 

```{r age density, echo=FALSE, message=FALSE, error=FALSE, warning=FALSE}

selected.spp %>% 
  drop_na(AGE)%>% 
  group_by(YEAR)%>%
  ggplot(aes(x=AGE, y=YEAR, fill= YEAR))+
  ggridges::geom_density_ridges2()+
  scale_x_continuous(limits = c(0,(max(selected.spp$AGE, na.rm = TRUE))), breaks = 0:max(selected.spp$AGE, na.rm = TRUE))
  
```




