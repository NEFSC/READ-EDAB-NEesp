---
title: "risk_plot"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: 
  html_document:
    toc: FALSE
    toc_float: 
      collapsed: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, 
                      fig.width = 8, fig.align = 'center')

library(ggplot2)
`%>%` <- dplyr::`%>%`

source(here::here("R", "character_to_factor.R"))
source(here::here("R/full_report_functions", "make_html_table.R"))

data <- read.csv(here::here("data/risk_ranking", "full_risk_data.csv"))
guild_data <- read.csv(here::here("data/risk_ranking", "guild_data.csv"))
guild_info <- read.csv(here::here("data/risk_ranking", "guild_info.csv"))
indicator_info <- read.csv(here::here("data/risk_ranking", "indicator_key.csv"))
```

# Risk ranking of Northeast stocks {.tabset .tabset-fade}

## Methods {.tabset .tabset-fade}

### Risk ranking
All stocks were ranked in order of increasing risk. The stock with the highest ranking is the stock determined to be at the highest risk. In this case, high risk has two meanings: (1) high importance (e.g., a stock with a high catch would have a high risk ranking for the catch indicator) or high vulnerability (e.g., a stock with low B/Bmsy would have a high risk ranking for the B/Bmsy indicator). The normalized rank was determined by dividing each stock's rank by the total number of stocks considered for that indicator. Stocks that were missing indicator measurements were assigned a normalized rank of 0.5.

```{r, indicators}
dat <- indicator_info %>%
  dplyr::arrange(Category)
make_html_table(dat, col_names = colnames(dat))
```

### Guilds
Guilds were determined from [previous reporting](https://repository.library.noaa.gov/view/noaa/5277). Guilds were further broken into small (<40cm) and large (>=40cm) size classes. To determine guild risk, the risk values for each species were averaged over all stock areas. Then risk values were averaged by guild. Guilds were ranked in each indicator category.

```{r, guild_info, results = "asis"}
guild_info <- guild_info %>% 
  dplyr::mutate(Scientific_name = paste("*", Scientific_name, "*", sep = "")) %>%
  dplyr::rename("Size" = "size") %>%
  dplyr::select(Guild, Size, Species, Scientific_name) %>%
  dplyr::arrange(Guild, Size) 

tables <- list()
for(i in unique(guild_info$Guild)){
  for(j in unique(guild_info$Size)) {
    dat <- guild_info %>%
      dplyr::filter(Guild == i,
                    Size == j) %>%
      dplyr::select(Species, Scientific_name)
    
    if(nrow(dat) > 1){
      dat <- dat  %>%
        knitr::kable(caption = paste(i, j)) 
      
      print(dat)
    }
  }
}
```

## Results {.tabset .tabset-fade}

### Stock risk {.tabset .tabset-fade .tabset-pills}
Ranks for all stocks. 

#### Figures {.tabset .tabset-fade}

The total risk (sum of all normalized risk values) is shown for each stock.

##### By region
```{r plot_more, fig.height = 12}
more <- data %>% dplyr::filter(n_stocks_per_region > 4) 

fig_more <- ggplot(more,
                   aes(x = reorder(stock, -total_risk),
                       y = paste(category, ": ", Indicator, sep = ""),
                       fill = norm_rank ))+
  geom_raster(stat = "identity")+
  geom_text(aes(x = reorder(stock, -total_risk),
                y = 0.5,
                label = label),
            angle = 90,
            hjust = 0,
            #cex = 3,
            color = "black")+
  theme_bw()+
  scale_fill_gradient2(high = "darkred", 
                       mid = "beige", 
                       low = "forestgreen", 
                       midpoint = 0.5,
                       name = "Normalized rank")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "top")+
  facet_wrap(facets = vars(Region),
             ncol = 2,
             scales = "free_x")+
  ylab("Indicator")

print(fig_more)

```

```{r plot_less, fig.height = 8}
less <- data %>% 
  dplyr::filter(n_stocks_per_region <= 4) %>%
  dplyr::mutate(Region2 = Region %>% 
                  stringr::str_replace("Georges Bank", "GB") %>% 
                  stringr::str_replace("Gulf of Maine", "GOM") %>%
                  stringr::str_replace("/", "/\n") %>%
                  stringr::str_replace("Northwestern", "NW")
                )

fig_less <- ggplot(less,
       aes(x = reorder(stock, -total_risk),
           y = paste(category, ": ", Indicator, sep = ""),
           fill = norm_rank ))+
  geom_raster(stat = "identity")+
  geom_text(aes(x = reorder(stock, -total_risk),
                y = 0.5,
                label = label),
            angle = 90,
            hjust = 0,
            #cex = 3,
            color = "black")+
  theme_bw()+
  scale_fill_gradient2(high = "darkred", 
                       mid = "beige", 
                       low = "forestgreen", 
                       midpoint = 0.5,
                       name = "Normalized rank")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none")+
  facet_wrap(facets = vars(Region2),
             ncol = 5,
             scales = "free_x")+
  ylab("Indicator")

print(fig_less)
```

##### In order of risk
```{r, all_stocks, fig.height = 15}
fig <- ggplot(data,
              aes(x = reorder(stock, -total_risk),
                  y = paste(category, 
                            ":\n", 
                            Indicator %>% 
                              stringr::str_replace_all("_", "\n"), 
                            sep = ""),
                  fill = norm_rank ))+
  geom_raster(stat = "identity")+
  geom_text(aes(x = reorder(stock, -total_risk),
                y = 0.5,
                label = paste(Region, " ", Species, ", ", 
                              total_risk %>% round(digits = 2), 
                              sep = "")),
            hjust = 0,
            #cex = 3,
            color = "black")+
  theme_bw()+
  scale_fill_gradient2(high = "darkred", 
                       mid = "beige", 
                       low = "forestgreen", 
                       midpoint = 0.5,
                       name = "Normalized rank")+
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top")+
  ylab("Indicator")+
  coord_flip()

print(fig)
```

#### Data  {.tabset .tabset-fade}
##### All data
```{r, data}
dat <- data %>% 
  dplyr::mutate(Value = Value %>%
                  round(digits = 2) %>%
                  format(scientific = FALSE,
                         big.mark = ","),
                norm_rank = norm_rank %>%
                  round(digits = 3),
                total_risk = total_risk %>%
                  round(digits = 2)) %>%
  dplyr::select(-X, -stock, -label) %>%
  character_to_factor()

make_html_table(dat, col_names = colnames(dat))
```

##### Total risk only
```{r, data_totrisk}
dat <- data %>%
  dplyr::select(Species, Region, total_risk, overall_rank) %>%
  dplyr::mutate(total_risk = total_risk %>%
                  round(digits = 2)) %>%
  dplyr::distinct() %>%
  character_to_factor()

make_html_table(dat, col_names = colnames(dat))
```

### Guild risk{.tabset .tabset-fade .tabset-pills}

#### Figure
```{r guild, fig.height = 12}
mycolors <-  grDevices::colorRampPalette(
  nmfspalette::nmfs_palette("regional web")(6))(guild_data$Indicator %>% 
                                                  unique() %>% length())

ggplot(guild_data,
       aes(x = reorder(paste(Guild, "\n", size) %>%
                         stringr::str_replace("_", "\n"), 
                       total_guild_risk),
           y = avg_guild_risk, 
           fill = legend_label)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = sample(mycolors),
                    name = "Indicator")+
  geom_text(aes(y = label_y,
                label = paste(rank, "out of 8")),
            stat = "identity",
            vjust = -0.6) +
  geom_text(aes(y = total_guild_risk,
                label = paste("sum of ranks:\n", sum_ranks)),
            stat = "identity",
            vjust = -0.6)+
  theme_bw()+
  xlab("Guild")+
  ylab("Average risk within guild")+
  ylim(c(0,14))+
  theme(legend.position = "bottom",
        legend.key.size = unit(1.75, 'lines'))+
      guides(fill=guide_legend(nrow=5))
```

#### Data
```{r, guild_data}
dat <- guild_data %>% 
  dplyr::mutate(Guild = paste(Guild, size)) %>%
  dplyr::select(Guild, n_guild_species, category, Indicator, avg_guild_risk, 
                rank, norm_rank, total_guild_risk, sum_ranks) %>%
  dplyr::mutate(avg_guild_risk = avg_guild_risk %>%
                  round(digits = 2) %>%
                  format(scientific = FALSE,
                         big.mark = ","),
                norm_rank = norm_rank %>%
                  round(digits = 3),
                total_guild_risk = total_guild_risk %>%
                  round(digits = 2)) %>%
  
  character_to_factor()

make_html_table(dat, col_names = colnames(dat))
```