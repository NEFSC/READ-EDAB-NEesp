---
title: "`r params$species_ID`"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"

output: 
  html_document:
    toc: TRUE
    number_sections: TRUE
    toc_float: 
      collapsed: FALSE
      title: "`r params$species_ID`"
    toc_depth: 5

params: 
  species_ID: "Acadian redfish" # common name of species
  
  latlong_data: data # strata
  shape: shape # shapefile
  
  asmt_sum_data: data # bbmsy, ffmsy, assessment ratings
  asmt_sum_source: "assessmentdata::stockAssessmentSummary"

  diet_data: data # allfh diet data
  
  survey_data: data # survey data
  survey_source: "survdat"

  rec_data: data # recreational catch (MRIP)
  
  asmt_data: data # assessmentdata:stockAssessmentData, for recruitment and catch
  asmt_source: "assessmentdata::stockAssessmentData"

---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F, 
                      fig.width = 8, fig.align = 'center')

library(ggplot2)

`%>%` <- dplyr::`%>%`
```

```{r, functions, include = FALSE}
source(here::here("R/full_report_functions", "get_diet.R"))
source(here::here("R/full_report_functions", "get_latlong.R"))
source(here::here("R/full_report_functions", "get_bf.R"))
source(here::here("R/full_report_functions", "get_survdat_info.R"))
source(here::here("R/full_report_functions", "get_length.R"))
source(here::here("R/full_report_functions", "get_rec_catch.R"))
source(here::here("R/full_report_functions", "get_lw.R"))
source(here::here("R/full_report_functions", "get_assessment.R"))
```

```{r, data, include = FALSE}
species <- params$species_ID

latlong_data <- params$latlong_data
latlong_data <- latlong_data[latlong_data$Species == species, ]

asmt_sum_data <- params$asmt_sum_data
asmt_sum_data <- asmt_sum_data[asmt_sum_data$Species == species, ]

survey_data <- params$survey_data
survey_data <- survey_data[survey_data$Species == species, ]

ad_rating_data <- asmt_sum_data %>% 
  dplyr::select(Species, Region, Assessment.Year, Last.Data.Year,
                Biological.Input.Data, Life.History.Data, 
                Composition.Input.Data, Ecosystem.Linkage, FSSI.Stock.,
                Review.Result) %>%
  dplyr::rename(`Assessment Year` = Assessment.Year,
                         `Last Data Year` = Last.Data.Year,
                         `Biological Data Rating (2019)` = Biological.Input.Data,
                         `Biological Data Rating (before 2019)` = Life.History.Data,
                         `Size Data Rating` = Composition.Input.Data,
                         `Ecosystem Linkage Data Rating` = Ecosystem.Linkage,
                         `FSSI status` = FSSI.Stock.,
                         `Review Result` = Review.Result)

diet_data <- params$diet_data
diet_data <- diet_data[diet_data$Species == species, ]

rec_data <- params$rec_data
rec_data <- rec_data[rec_data$Species == species, ]

asmt_data <- params$asmt_data
asmt_data <- asmt_data[asmt_data$Species == species, ]
```

```{r, bf_status}
if(length(asmt_sum_data$Species) > 1){
  list_regions <- split(unique(asmt_sum_data$Region), f = list(unique(asmt_sum_data$Region)))
  bbmsy2 <- purrr::map(list_regions, ~status(data = asmt_sum_data, regions = .x, metric = "bbmsy"))
  ffmsy2 <- purrr::map(list_regions, ~status(data = asmt_sum_data, regions = .x, metric = "ffmsy"))
} else {
  bbmsy2 <- "UNKNOWN"
  ffmsy2 <- "UNKNOWN"
}

```

```{r, legend}
# set colors and linetypes to be constant for all regions
reg <- c(asmt_sum_data$Region, asmt_data$Region) %>% unique()

lines <- 1:length(reg)
names(lines) <- reg

colors <- nmfspalette::nmfs_palette("regional web")(length(reg))
names(colors) <- reg

```

This is a preliminary report of previously collected data. This report is pulling information on all Northeast `r species` stocks.

# Methods

## General methods
Northeast stocks were identified from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv).

Data sources for each analysis are identified in the Results.

All continuous temporal data were plotted against time. If there were 30 or more years of data, a geom_gls regression line was fit (yellow = significant increase; purple = significant decrease; no line = no significant trend). If there were fewer than 30 years of data, no regression was fit.

## `assessmentdata` methods
Stock assessment and data quality information were compiled into a summary table.

B/Bmsy was classified as "DANGER" if it was below 1 and "GOOD" if it was above 1.

F/Fmsy was classified as "DANGER" if it was above 1 and "GOOD" if it was below 1.


## `survdat` methods
`survdat` data with zero abundance were not included in this analysis. Abundance and biomass were summed for each year and season. All other metrics were averaged for each year and season. The tables show summary statistics for the entire time series and for the most recent 5 years in the time series. 

# Results

## Latitude and longitude
Latitude and longitude ranges were compiled from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv) and [Bottom Trawl Survey (BTS) shapefiles](https://github.com/NOAA-EDAB/ECSA/tree/master/data/strata_shapefiles). The coordinate system is WGS84.
```{r, latlong}
if(length(latlong_data$Species) >= 1){
  get_latlong(species, latlong_data, shapefile = params$shape) %>%
  tibble::as_tibble() %>%
  knitr::kable()
} else print("NO DATA")
```

## Stock assessment and data quality information
Stock assessment and data quality information were pulled from ``r params$asmt_sum_source``.
```{r, quality}
if(length(ad_rating_data$Species) >= 1){
  knitr::kable(ad_rating_data)
} else print("NO DATA")
```

## B/Bmsy
B/Bmsy data were pulled from ``r params$asmt_sum_source``.

The most recent status of B/Bmsy is: `r bbmsy2`
```{r, bbmsy} 
if("GOOD" %in% bbmsy2 | "DANGER" %in% bbmsy2){
  plot_bbmsy(asmt_sum_data[which(is.na(asmt_sum_data$B.Bmsy) == FALSE), ], 
             ytitle = "B / Bmsy",
             lin = lines,
             col = colors)
} else print("NO DATA")
```

## F/Fmsy
F/Fmsy data were pulled from ``r params$asmt_sum_source``.

The most recent status of F/Fmsy is: `r ffmsy2`
```{r, ffmsy}
if("GOOD" %in% ffmsy2 | "DANGER" %in% ffmsy2){
 plot_ffmsy(asmt_sum_data[which(is.na(asmt_sum_data$F.Fmsy) == FALSE), ],
                      ytitle = "F / Fmsy",
             lin = lines,
             col = colors)
} else print("NO DATA")
```

## Recruitment
Recruitment data were pulled from ``r params$asmt_source``. Separate geom_gls() functions were fit for each region; trend lines are only shown when the trend was statistically significant, so some plots may have fewer trend lines than regions.
```{r, recruitment}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Recruitment")) > 0){
plot_asmt(asmt_data, 
          metric = "Recruitment", 
          ytitle = "Recruitment",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

## Diet
Diet data were compiled from [existing data](https://github.com/Laurels1/Condition/blob/master/data/allfh.RData). For analysis, all geographic samples were grouped by season, year, and region, and only year-season-region combinations with more than 20 predators sampled were considered. Prey items that made up more than 5% of the predator's diet in at least one year-season-region were identified to the broad category level; all other prey are grouped into the "other" category.
```{r, diet}
if(length(diet_data$Species) >= 1){
  get_diet(data = diet_data)
} else print("NO DATA")
```

## Temperature

### Surface temperature
Surface temperature data were pulled from ``r params$survey_source``. Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, surftemp}
if(sum(is.na(survey_data$SURFTEMP)) < length(survey_data$SURFTEMP)){
  generate_info(survey_data,
              variable = "SURFTEMP", 
              ytitle = "Surface temperature")
} else print("NO DATA")
```

### Bottom temperature
Bottom temperature data were pulled from ``r params$survey_source``. Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, bottemp}
if(sum(is.na(survey_data$BOTTEMP)) < length(survey_data$BOTTEMP)){
  generate_info(survey_data,
              variable = "BOTTEMP", 
              ytitle = "Bottom temperature")
} else print("NO DATA")
```

## Salinity 

### Surface salinity
Surface salinity data were pulled from ``r params$survey_source``. Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, surfsalin}
if(sum(is.na(survey_data$SURFSALIN)) < length(survey_data$SURFSALIN)){
  generate_info(survey_data,
              variable = "SURFSALIN", 
              ytitle = "Surface salinity")
} else print("NO DATA")
```

### Bottom salinity
Bottom salinity data were pulled from ``r params$survey_source``. Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, botsalin}
if(sum(is.na(survey_data$BOTSALIN)) < length(survey_data$BOTSALIN)){
  generate_info(survey_data,
              variable = "BOTSALIN", 
              ytitle = "Bottom salinity")
} else print("NO DATA")
```

## Abundance
### ``r params$survey_source``
Abundance data were pulled from ``r params$survey_source``. Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, abundance}
if(sum(is.na(survey_data$ABUNDANCE)) < length(survey_data$ABUNDANCE)){
  generate_info(survey_data,
              variable = "ABUNDANCE", 
              ytitle = "Abundance")
} else print("NO DATA")
```

### `assessmentdata`
Abundance data were pulled from ``r params$asmt_source``. Separate geom_gls() functions were fit for each region; trend lines are only shown when the trend was statistically significant, so some plots may have fewer trend lines than regions.
```{r, abun_asmt}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Abundance")) > 0){
plot_asmt(asmt_data, 
          metric = "Abundance", 
          ytitle = "Abundance",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

## Biomass
Biomass data were pulled from ``r params$survey_source``. Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, biomass}
if(sum(is.na(survey_data$BIOMASS)) < length(survey_data$BIOMASS)){
  generate_info(survey_data,
              variable = "BIOMASS", 
              ytitle = "Biomass")
} else print("NO DATA")
```

## Catch

### Catch
Catch statistics from ``r params$asmt_source``.
```{r, catch}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Catch")) > 0){
plot_asmt(asmt_data, 
          metric = "Catch", 
          ytitle = "Catch",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

### Recreational catch
Recreational catch data were downloaded from [NOAA MRIP](https://www.st.nmfs.noaa.gov/st1/recreational/MRIP_Estimate_Data/CSV/).
```{r, rec}
if(length(rec_data$Species) > 0){
  get_rec_catch(rec_data)
} else print("NO DATA")
```

## Length
Length data were pulled from ``r params$survey_source``. Only years with more than 10 fish lengths were considered for analysis. Separate geom_gls() functions were fit for the minimum, mean, and maximum lengths; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than three trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, length}
if(sum(is.na(survey_data$LENGTH)) < length(survey_data$LENGTH)){
  generate_len_info(survey_data)
} else print("NO DATA")
#print("Length analysis is currently under construction.")
```

## Condition
Condition information was derived from [diet data](https://github.com/Laurels1/Condition/blob/master/data/allfh.RData). 

### Length vs weight
Length vs weight for all geographic samples by decade. Please note, no trend lines were fit, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, lw}
if(length(diet_data$Species) >= 1){
plot_lw(diet_data)
} else print("NO DATA")
```

### Condition factor
We calculated a rough condition factor as: Weight / Length^3. If there were more than 30 years of data, a geom_gls() regression was fit. In order to fit the geom_gls() regression, we calculated the mean condition factor for each year and plotted the geom_gls() through those points. Please note, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, condition}
if(length(diet_data$Species) >= 1){
plot_cond(diet_data)
} else print("NO DATA")
```