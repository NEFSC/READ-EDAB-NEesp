# Risk assessment

```{r, risk_functions, include = FALSE}
source(here::here("R/rank_species_indicators", "plot_risk_by_species.R"))
source(here::here("R/rank_species_indicators", "plot_risk_by_year.R"))
```

```{r, risk_data, include = FALSE}
risk_data <- params$risk_data
risk_data <- risk_data[risk_data$Species == species, ]

risk_year_data <- params$risk_year_data
risk_year_data <- risk_year_data[risk_year_data$Species == species, ]

risk_species_data <- params$risk_species_data
risk_species_data <- risk_species_data[risk_species_data$Species == species, ]
```

## Preliminary risk calculation

A preliminary risk analysis was conducted by ranking all species according to their indicator values. A high rank number and a normalized rank near 1 indicates that the species is at risk or of importance based on the measured indicator values. When a species was missing an indicator, it was assigned a normalized rank of 0.5.

```{r, risk}
data <- risk_data %>% dplyr::mutate(Rank = paste(rank, "out of", n_stocks_per_indicator),
                       Value2 = Value %>% 
                         format(big.mark = ",", scientific = FALSE, digits = 2),
                       Normalized_rank = norm_rank %>% round(digits = 2)) %>%
  dplyr::select(Region, category, Indicator, Year, Value2, Rank, Normalized_rank) %>%
  dplyr::rename("Value" = "Value2") %>%
  character_to_factor()

make_html_table(data, col_names = c("Region", "Category", "Indicator", "Year", "Value",
                       "Rank", "Normalized rank"))
```

## Preliminary risk visualization

### Relative to all other stocks

Risk was calculated over time for all indicators that were documented for five or more species in a given year. Risk was calculated as the average of the past 5 years, as a percent of the historical average. The normalized risk value plotted here reflects the normalized rank of this stock compared to all other stocks in that year.

```{r, year_risk}
plot_risk_by_year(risk_year_data,
                  indicator = "all")
```

### Within a single stock

For each stock, each indicator was ranked for all years where a value was present. The normalized risk values plotted here reflects the normalized rank of each year compared to all other years.

```{r, stock_risk}
plot_risk_by_stock(risk_species_data,
                  indicator = "all")
```