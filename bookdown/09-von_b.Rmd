## von Bertalanffy growth curve

Ricky Tabandera

```{r setup_vonb, cache = params$cache}
#install.packages("ggrepel")
#install.packages("ggpubr")
#devtools::install_github("james-thorson/FishLife")

suppressPackageStartupMessages(library(FishLife))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(nlstools))
library(rfishbase)
library(ggpubr)
library(FSA)

```



```{r data_wrangling, cache = params$cache, cache.lazy = FALSE}

survdata<-readRDS(here::here("survdat_pull_bio.rds"))

survdata<-survdata %>% mutate(SVSPP=as.numeric(SVSPP))
stock_list_all_strata <- read.csv("https://raw.githubusercontent.com/NOAA-EDAB/ECSA/master/data/stock_list.csv")
stock_list_all_strata<-stock_list_all_strata %>% rename(SVSPP=svspp)
stock_list<-stock_list_all_strata %>% dplyr::distinct(SVSPP,.keep_all =T)

survdata.w.codes<-inner_join(survdata, stock_list, by= "SVSPP" )

selected.surv<-survdata.w.codes %>% filter(common_name ==params$stock)


#only take records with age associated
selected.surv.clean<-selected.surv %>% drop_na(AGE)
#define the type of von b model
vb <- vbFuns(param="Typical")
#define starting parameters based on the avalible data 
f.starts<-FSA::vbStarts(LENGTH~AGE ,data = selected.surv.clean,methLinf="Walford" )

#fit a non-linear least squares model based on the data and starting values 
f.fit <- nls(LENGTH~vb(AGE,Linf,K,t0),data=selected.surv.clean, start=f.starts)
#store the fit parameters for later investigation
f.fit.summary<-summary(f.fit,correlation=TRUE)

#define the range of age values that will be used to generate points from the fitted model
#roughly by 0.2 year steps
newages<- data.frame(AGE=seq(0, 50, length = 250))
#predict(f.fit,newdata=newages) this funtion uses the model from f.fit to generate new lengths 
#make a dataset with the values from the model
selected.surv.vonb<-data.frame(AGE=seq(1, 50, length = 250), LENGTH=predict(f.fit,newdata=newages))




#########################################################




```

```{r, vonb_species}

ricky_stock <- stringr::str_to_lower(species)
#########################################################
#logical filtering of params for plotting

```

### Length at age growth curve

The predicted von Bertalanffy growth curve for NMFS managed fish species. Growth parameters of Linf (Length infinty), K (growth coefficient), and t0 (size at time 0) were estimated using non-linear least square model. The starting point for model building is accomplished using FSA::vbStarts. Age and length data sourced from Survdat and spans all years and survey areas. 

`r if(params$stock == "monkfish"){"The age determination method for monkfish has not been validated, and the anatomic structure used has changed through time. In addition these stocks display a high degree of sexual dimorphisms making fitting of single growth curves unreliable.  This results a high degree of uncertainty in assessing the age structure of the stock and the effects of fishing pressure."}`



```{r single_growth_curve}
if(nrow(selected.surv.vonb) > 0){
  selected.surv.vonb %>%
  ggplot(aes(x=AGE, y=LENGTH))+
  geom_line(color= "blue",size=1.4)+
  xlab("Age")+
  ylab(" Total length (cm)")+
  labs(color="Common name of stock")+
  ggtitle(str_to_sentence(ricky_stock), subtitle = "Length at age")+
  theme_minimal()+
  geom_point(data=selected.surv,aes(x=AGE, y=LENGTH), color="red")+
  xlim(0,(1.5*max(selected.surv$AGE, na.rm = TRUE)))+
  ylim(0,(1.5*max(selected.surv$LENGTH, na.rm = TRUE)))


} else print("NO DATA")

```

```{r missing_vonb, eval = missing}
 print("NO DATA")
```