---
title: "`r params$species_ID`"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    split_by: section
documentclass: book
github-repo: NOAA-EDAB/esp_data_aggregation

language:
  ui:
    chapter_name: "Section "

params: 
  species_ID: "Acadian redfish" # common name of species
  
  latlong_data: data # strata
  shape: shape # shapefile
  
  asmt_sum_data: data # bbmsy, ffmsy, assessment ratings
  asmt_sum_source: "assessmentdata::stockAssessmentSummary"

  diet_data: data # allfh diet data
  
  survey_data: data # survey data
  survey_source: "survdat"
  
  ricky_survey_data: data # ricky survey data

  rec_data: data # recreational catch (MRIP)
  
  asmt_data: data # assessmentdata:stockAssessmentData, for recruitment and catch
  asmt_source: "assessmentdata::stockAssessmentData"
  
  cond_data: data # Laurel's condition data
  
  risk_data: data # relative risk rankings
  
  com_data: data # commercial catch
  
  swept_data: data # swept area estimates
  
  risk_year_hist_data: data # historical risk by year
  
  risk_year_value_data: data # value risk by year
  
  risk_species_data: data # species risk
  
  cache: FALSE
---

# `r params$species` {-}

```{r, setup, include = FALSE}
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- difftime(Sys.time(), now) %>% round(digits = 2)
      # return a character string to show the time
      paste("Time for this code chunk to run:", res)
    }
  }
}))

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE, 
                      warning = FALSE, 
                      #time_it = TRUE,
                      fig.width = 8, 
                      fig.align = 'center',
                      fig.cap = params$species
                     # cache.path = here::here("bookdown/cache/", "")
                      )
```

```{r, setup2, cache = params$cache}
library(ggplot2)

`%>%` <- dplyr::`%>%`
```

```{r, universal_functions, cache = params$cache}
source(here::here("R", "character_to_factor.R"))
source(here::here("R/full_report_functions", "make_html_table.R"))

source(here::here("R/full_report_functions/risk_functions", "plot_risk_by_year.R"))
source(here::here("R/full_report_functions/risk_functions", "plot_risk_within_species.R"))
```

```{r, species_data}
# data used in multiple chapters
species <- params$species_ID

risk_year_hist_data <- params$risk_year_hist_data[params$risk_year_hist_data$Species == species, ]

risk_year_value_data <- params$risk_year_value_data[params$risk_year_value_data$Species == species, ]

risk_species_data <- params$risk_species_data[params$risk_species_data$Species == species, ]
```

This is a preliminary report of previously collected data. This report is pulling information on all Northeast `r species` stocks.

<!--chapter:end:index.Rmd-->


# Methods

Placeholder


## Stock identification
## Data collection and presentation
### `assessmentdata` methods
### `survdat` methods
## Risk assessment
### Risk across stocks
#### Suite of indicators
#### Individual indicators
### Risk within stocks

<!--chapter:end:01-methods.Rmd-->

# Habitat information

<!--chapter:end:02-habitat-title-page.Rmd-->

## Distribution

```{r, geo_functions, cache = params$cache}
source(here::here("R/full_report_functions", "get_latlong.R"))
source(here::here("R/full_report_functions", "map_strata_ecsa.R"))
```

```{r, geo_data_species}
latlong_data <- params$latlong_data[params$latlong_data$Species == species, ]
```

### Map of distribution
Strata maps were pulled and compiled using code from [NOAA/EDAB ECSA](https://github.com/NOAA-EDAB/ECSA). Please note, only fall and spring strata are shown on the map.
```{r, ecsa_map}
map_strata_ecsa(data = latlong_data,
                species_name = species)
```

### Latitude and longitude ranges
Latitude and longitude ranges were calculated from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv) and [Bottom Trawl Survey (BTS) shapefiles](https://github.com/NOAA-EDAB/ECSA/tree/master/data/strata_shapefiles). The coordinate system is WGS84.
```{r, latlong}
data <- get_latlong(species, latlong_data, shapefile = params$shape) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

<!--chapter:end:03-latlong.Rmd-->



## Temperature
### Figures
### Summary
### Data

<!--chapter:end:04-temperature.Rmd-->



## Salinity
### Figures
### Summary
### Data

<!--chapter:end:05-salinity.Rmd-->



## Depth
### Figures

<!--chapter:end:06-depth.Rmd-->

## Habitat vulnerability

```{r, vul_functions}
source(here::here("R/full_report_functions", "plot_vulnerability.R"))

data <- read.csv(here::here("data", "Hare_et_al_2016_overall.csv"))
```

Habitat vulnerability information is sourced from the `ecodata` package. 

```{r, hab_vul}
data <- ecodata::habitat_vulnerability %>%
  dplyr::filter(Species == species) %>%
  dplyr::select(-Species)

data <- data[,c(8, 1:7)]

make_html_table(data,
                col_names = c("EPU", "Habitat name", "Habitat vulnerability", 
                             "Importance of habitat to eggs/larvae",
                             "Importance of habitat to juveniles/YOY",
                             "Importance of habitat to adults",
                             "Importance of habitat to spawning adults",
                             "Overall species vulnerability"))

```

<!--chapter:end:07-habitat-vulnerability.Rmd-->

# Biological information

<!--chapter:end:08-biological-title-page.Rmd-->



## Length
### Figures
#### Risk {-}
### Summary
### Data

<!--chapter:end:09-length.Rmd-->



## von Bertalanffy growth curve
### Length at age growth curve

<!--chapter:end:10-von_b.Rmd-->



## Condition
### Figures
#### Length vs weight
#### Condition factor: Weight-volume
#### Condition factor: Relative weight
### Data
#### Length vs weight with weight-volume condition factor
#### Relative weight condition factor

<!--chapter:end:11-condition.Rmd-->



## Diet
### Figure
### Summary
### Data

<!--chapter:end:12-diet.Rmd-->

# Population information

<!--chapter:end:13-population-title-page.Rmd-->



## Abundance
### Figures
#### Survey abundance (raw measurements)
##### Risk {-}
#### Survey abundance (swept area estimates)
#### Assessment abundance
##### Risk {-}
### Survey summary
### Data
#### Survey data (raw measurements)
#### Survey data (swept area estimates)
#### Assessment data

<!--chapter:end:14-abundance.Rmd-->



## Biomass
### Figures
#### Survey biomass (raw measurements)
##### Risk {-}
#### Survey biomass (swept area estimates)
#### Assessment biomass
##### Risk {-}
### Survey summary
### Data
#### Survey data (raw measurements)
#### Survey data (swept area estimates)
#### Assessment data

<!--chapter:end:15-biomass.Rmd-->



## B/Bmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:16-bbmsy.Rmd-->



## Recruitment
### Figure
##### Risk
### Data

<!--chapter:end:17-recruitment.Rmd-->



## Climate vulnerability
### Figures
### Data

<!--chapter:end:18-climate-vulnerability.Rmd-->

# Socio-economic information

<!--chapter:end:19-socio-economic-title-page.Rmd-->


# Management information

Placeholder


## Stock assessment and data quality information

<!--chapter:end:2-management.Rmd-->



## Catch
### Figures
#### Stock assessment catch
##### Risk {-}
#### Recreational catch
##### Risk {-}
#### Commercial catch
##### Risk {-}
#### Commercial vs recreational catch
### Data
#### Stock assessment catch
#### Recreational catch
#### Commercial catch
#### Commercial vs recreational catch
#### Commercial, recreational, and stock assessment catch

<!--chapter:end:20-catch.Rmd-->



## F/Fmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:21-ffmsy.Rmd-->



## Revenue 
### Figure
##### Risk {-}
### Data

<!--chapter:end:22-revenue.Rmd-->


# Risk assessment

Placeholder


## Preliminary risk calculation
### Relative to all other stocks
### Within each stock
## Preliminary risk visualization
### Relative to all other stocks
### Within a single stock

<!--chapter:end:23-risk-assessment.Rmd-->



## L50 maturity
## Size at first maturity 
## Model results
## L50 across time

<!--chapter:end:24-length50maturity.Rmd-->

