---
title: "`r params$species_ID`"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    split_by: section
documentclass: book
github-repo: NOAA-EDAB/esp_data_aggregation

language:
  ui:
    chapter_name: "Section "

params: 
  species_ID: "Acadian redfish" # common name of species
  
  latlong_data: data # strata
  shape: shape # shapefile
  
  asmt_sum_data: data # bbmsy, ffmsy, assessment ratings
  asmt_sum_source: "assessmentdata::stockAssessmentSummary"

  diet_data: data # allfh diet data
  
  survey_data: data # survey data
  survey_source: "survdat"
  
  ricky_survey_data: data # ricky survey data

  rec_data: data # recreational catch (MRIP)
  
  asmt_data: data # assessmentdata:stockAssessmentData, for recruitment and catch
  asmt_source: "assessmentdata::stockAssessmentData"
  
  cond_data: data # Laurel's condition data
  
  risk_data: data # relative risk rankings
  
  com_data: data # commercial catch
  
  swept_data: data # swept area estimates
  
  risk_year_hist_data: data # historical risk by year
  
  risk_year_value_data: data # value risk by year
  
  risk_species_data: data # species risk
  
  cache: FALSE
---

# `r params$species` {-}

Placeholder



<!--chapter:end:index.Rmd-->


# Methods

Placeholder


## Stock identification
## Data collection and presentation
### `assessmentdata` methods
### `survdat` methods
## Risk assessment
### Risk across stocks
#### Suite of indicators
#### Individual indicators
### Risk within stocks

<!--chapter:end:01-methods.Rmd-->

# Habitat information

<!--chapter:end:02-habitat-title-page.Rmd-->

## Distribution

```{r, geo_functions, cache = params$cache}
source(here::here("R/full_report_functions", "get_latlong.R"))
source(here::here("R/full_report_functions", "map_strata_ecsa.R"))
```

```{r, geo_data_species}
latlong_data <- params$latlong_data[params$latlong_data$Species == species, ]
```

### Map of distribution
Strata maps were pulled and compiled using code from [NOAA/EDAB ECSA](https://github.com/NOAA-EDAB/ECSA). Please note, only fall and spring strata are shown on the map.
```{r, ecsa_map}
map_strata_ecsa(data = latlong_data,
                species_name = species)
```

### Latitude and longitude ranges
Latitude and longitude ranges were calculated from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv) and [Bottom Trawl Survey (BTS) shapefiles](https://github.com/NOAA-EDAB/ECSA/tree/master/data/strata_shapefiles). The coordinate system is WGS84.
```{r, latlong}
data <- get_latlong(species, latlong_data, shapefile = params$shape) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

<!--chapter:end:03-latlong.Rmd-->



## Temperature
### Figures
### Summary
### Data

<!--chapter:end:04-temperature.Rmd-->



## Salinity
### Figures
### Summary
### Data

<!--chapter:end:05-salinity.Rmd-->



## Depth
### Figures

<!--chapter:end:06-depth.Rmd-->

# Biological information

<!--chapter:end:07-biological-title-page.Rmd-->



## Length
### Figures
#### Risk {-}
### Summary
### Data

<!--chapter:end:08-length.Rmd-->



## von Bertalanffy growth curve
### Length at age growth curve
### Growth by size class

<!--chapter:end:09-von_b.Rmd-->



## Condition
### Figures
#### Length vs weight
#### Condition factor: Weight-volume
#### Condition factor: Relative weight
### Data
#### Length vs weight with weight-volume condition factor
#### Relative weight condition factor

<!--chapter:end:10-condition.Rmd-->



## Diet
### Figure
### Summary
### Data

<!--chapter:end:11-diet.Rmd-->

# Population information

<!--chapter:end:12-population-title-page.Rmd-->



## Abundance
### Figures
#### Survey abundance (raw measurements)
##### Risk {-}
#### Survey abundance (swept area estimates)
#### Assessment abundance
##### Risk {-}
### Survey summary
### Data
#### Survey data (raw measurements)
#### Survey data (swept area estimates)
#### Assessment data

<!--chapter:end:13-abundance.Rmd-->



## Biomass
### Figures
#### Survey biomass (raw measurements)
##### Risk {-}
#### Survey biomass (swept area estimates)
#### Assessment biomass
##### Risk {-}
### Survey summary
### Data
#### Survey data (raw measurements)
#### Survey data (swept area estimates)
#### Assessment data

<!--chapter:end:14-biomass.Rmd-->



## B/Bmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:15-bbmsy.Rmd-->



## Recruitment
### Figure
##### Risk
### Data

<!--chapter:end:16-recruitment.Rmd-->

# Socio-economic information

<!--chapter:end:17-socio-economic-title-page.Rmd-->



## Catch
### Figures
#### Stock assessment catch
##### Risk {-}
#### Recreational catch
##### Risk {-}
#### Commercial catch
##### Risk {-}
#### Commercial vs recreational catch
### Data
#### Stock assessment catch
#### Recreational catch
#### Commercial catch
#### Commercial vs recreational catch
#### Commercial, recreational, and stock assessment catch

<!--chapter:end:18-catch.Rmd-->



## F/Fmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:19-ffmsy.Rmd-->



## Revenue 
### Figure
##### Risk {-}
### Data

<!--chapter:end:20-revenue.Rmd-->


# Management information

Placeholder


## Stock assessment and data quality information

<!--chapter:end:21-management.Rmd-->

# Vulnerability

```{r, vul_functions}
source(here::here("R/full_report_functions", "plot_vulnerability.R"))
```

## Climate vulnerability

Climate vulnerability is sourced from Hare et al. (2016).

```{r, clim_vul}
data <- read.csv(url("https://doi.org/10.1371/journal.pone.0146756.s001")) %>%
  dplyr::mutate(Species = Species %>%
                  stringr::str_to_sentence()) %>%
  dplyr::filter(Species == species) %>%
  dplyr::select(-Species)
```

### Figures
```{r, fig.height = 10}
plot_climate_vulnerability(data)
```

### Data
```{r}
make_html_table(data,
                col_names = c("Functional group", "Attribute", "Attribute category", 
                             "Expert score: low",
                             "Expert score: moderate",
                             "Expert score: high",
                             "Expert score: very high"))
```

## Habitat vulnerability

Habitat information is sourced from the `ecodata` package. 

```{r, hab_vul}
data <- ecodata::habitat_vulnerability %>%
  dplyr::filter(Species == species) %>%
  dplyr::select(-Species)

make_html_table(data,
                col_names = c("EPU", "Habitat name", "Habitat vulnerability", 
                             "Importance of habitat to eggs/larvae",
                             "Importance of habitat to juveniles/YOY",
                             "Importance of habitat to adults",
                             "Importance of habitat to spawning adults",
                             "Overall species vulnerability"))

```

<!--chapter:end:22-vulnerability.Rmd-->


# Risk assessment

Placeholder


## Preliminary risk calculation
### Relative to all other stocks
### Within each stock
## Preliminary risk visualization
### Relative to all other stocks
### Within a single stock

<!--chapter:end:23-risk-assessment.Rmd-->

