---
title: "`r params$species_ID`"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    split_by: section
documentclass: book
github-repo: NOAA-EDAB/esp_data_aggregation

language:
  ui:
    chapter_name: "Section "

params: 
  species_ID: "Acadian redfish" # common name of species
  
  latlong_data: data # strata
  shape: shape # shapefile
  
  asmt_sum_data: data # bbmsy, ffmsy, assessment ratings
  asmt_sum_source: "assessmentdata::stockAssessmentSummary"

  diet_data: data # allfh diet data
  
  survey_data: data # survey data
  survey_source: "survdat"
  
  ricky_survey_data: data # ricky survey data

  rec_data: data # recreational catch (MRIP)
  
  asmt_data: data # assessmentdata:stockAssessmentData, for recruitment and catch
  asmt_source: "assessmentdata::stockAssessmentData"
  
  cond_data: data # Laurel's condition data
  
  risk_data: data # relative risk rankings
  
  com_data: data # commercial catch
  
  swept_data: data # swept area estimates
  
  risk_year_hist_data: data # historical risk by year
  
  risk_year_value_data: data # value risk by year
  
  risk_species_data: data # species risk
  
  cache: FALSE
---

# `r params$species` {-}

```{r, setup, include = FALSE}
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- difftime(Sys.time(), now) %>% round(digits = 2)
      # return a character string to show the time
      paste("Time for this code chunk to run:", res)
    }
  }
}))

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE, 
                      warning = FALSE, 
                      #time_it = TRUE,
                      fig.width = 8, 
                      fig.align = 'center',
                      fig.cap = params$species,
                     # cache.path = here::here("bookdown/cache/", "")
                      )
```

```{r, setup2, cache = params$cache}
library(ggplot2)

`%>%` <- dplyr::`%>%`
```

```{r, universal_functions, cache = params$cache}
source(here::here("R", "character_to_factor.R"))
source(here::here("R/full_report_functions", "make_html_table.R"))

source(here::here("R/full_report_functions/risk_functions", "plot_risk_by_year.R"))
source(here::here("R/full_report_functions/risk_functions", "plot_risk_within_species.R"))
```

```{r, species_data}
# data used in multiple chapters
species <- params$species_ID

risk_year_hist_data <- params$risk_year_hist_data[params$risk_year_hist_data$Species == species, ]

risk_year_value_data <- params$risk_year_value_data[params$risk_year_value_data$Species == species, ]

risk_species_data <- params$risk_species_data[params$risk_species_data$Species == species, ]
```

This is a preliminary report of previously collected data. This report is pulling information on all Northeast `r species` stocks.

<!--chapter:end:index.Rmd-->


# Methods

Placeholder


## Stock identification
## Data collection and presentation
### `assessmentdata` methods
### `survdat` methods
## Risk assessment
### Risk across stocks
#### Suite of indicators
#### Individual indicators
### Risk within stocks

<!--chapter:end:01-methods.Rmd-->

# Habitat information

<!--chapter:end:02-habitat-title-page.Rmd-->

## Distribution

```{r, geo_functions, cache = params$cache}
source(here::here("R/full_report_functions", "get_latlong.R"))
source(here::here("R/full_report_functions", "map_strata_ecsa.R"))
```

```{r, geo_data_species}
latlong_data <- params$latlong_data[params$latlong_data$Species == species, ]
```

### Map of distribution
Strata maps were pulled and compiled using code from [NOAA/EDAB ECSA](https://github.com/NOAA-EDAB/ECSA). Please note, only fall and spring strata are shown on the map.
```{r, ecsa_map}
map_strata_ecsa(data = latlong_data,
                species_name = species)
```

### Latitude and longitude ranges
Latitude and longitude ranges were calculated from NOAA/EDAB ECSA [seasonal species strata](https://github.com/NOAA-EDAB/ECSA/blob/master/data/seasonal_stock_strata.csv) and [Bottom Trawl Survey (BTS) shapefiles](https://github.com/NOAA-EDAB/ECSA/tree/master/data/strata_shapefiles). The coordinate system is WGS84.
```{r, latlong}
data <- get_latlong(species, latlong_data, shapefile = params$shape) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

<!--chapter:end:03-latlong.Rmd-->



## Temperature
### Figures
### Summary
### Data

<!--chapter:end:04-temperature.Rmd-->



## Salinity
### Figures
### Summary
### Data

<!--chapter:end:05-salinity.Rmd-->



## Depth
### Figures

<!--chapter:end:06-depth.Rmd-->

# Biological information

<!--chapter:end:07-biological-title-page.Rmd-->



## Length
### Figures
#### Risk {-}
### Summary
### Data

<!--chapter:end:08-length.Rmd-->



## von Bertalanffy growth curve
### Length at age growth curve
### Growth by size class

<!--chapter:end:09-von_b.Rmd-->



## Condition
### Figures
#### Length vs weight
#### Condition factor: Weight-volume
#### Condition factor: Relative weight
### Data
#### Length vs weight with weight-volume condition factor
#### Relative weight condition factor

<!--chapter:end:10-condition.Rmd-->



## Diet
### Figure
### Summary
### Data

<!--chapter:end:11-diet.Rmd-->

# Population information

<!--chapter:end:12-population-title-page.Rmd-->

## Abundance

```{r, abun_functions, cache = params$cache}
source(here::here("R/full_report_functions", "get_assessment.R"))
source(here::here("R/full_report_functions", "get_survdat_info.R"))
source(here::here("R/full_report_functions", "get_swept.R"))
```

```{r, abun_data_species}
survey_data <- params$survey_data[params$survey_data$Species == species, ]

asmt_data <- params$asmt_data[params$asmt_data$Species == species, ]

asmt_sum_data <- params$asmt_sum_data[params$asmt_sum_data$Species == species, ]

swept_data <- params$swept_data[params$swept_data$Species == species, ]
```

```{r, child = here::here("bookdown", "_legend-child-doc.Rmd")}
```

Abundance data were pulled from ``r params$survey_source`` and ``r params$asmt_source``. 

### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.

#### Survey abundance (raw measurements)
```{r, abun_survey}
generate_plot(survey_data,
              variable = "ABUNDANCE", 
              ytitle = "Abundance")
```

##### Risk {-}

See Methods for risk calculation details.
```{r}
indicators <- c("abundance_spring", 
                "abundance_fall")
```

```{r, child = here::here("bookdown", "_risk-child-doc.Rmd")}
```

#### Survey abundance (swept area estimates)

Please note, these estimates are not parsed by region or season. Swept area estimates are based on spring and fall surveys only. The shaded gray region indicates +/- two standard errors.
```{r, abun_survey_swept}
plot_swept(swept_data, var = "abundance")
```

#### Assessment abundance
```{r}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Abundance")) > 0){
ndesc <- asmt_data %>% 
  dplyr::filter(Metric == "Abundance") %>% 
  #dplyr::mutate(options = paste(Description, Units)) %>%
  dplyr::select(Age) %>% 
  unique() %>% 
  nrow()
} else ndesc <- 1
```

```{r, abun_asmt, fig.height = ndesc * 4}
plot_asmt(asmt_data, 
          metric = "Abundance", 
          ytitle = "Abundance",
          lin = lines, 
          col = colors)
```

##### Risk {-}

See Methods for risk calculation details.
```{r}
indicators <- c("asmt_abundance")
```

```{r, child = here::here("bookdown", "_risk-child-doc.Rmd")}
```

### Survey summary
```{r, abun_summary}
generate_table(survey_data,
              variable = "ABUNDANCE", 
              cap = "Measured abundance")
```

### Data

#### Survey data (raw measurements)
```{r, surv_abun_data}
data <- survey_data %>%
  get_var_data(variable = "ABUNDANCE") %>%
  dplyr::mutate(variable = variable %>%
                  format(big.mark = ","))  %>%
  character_to_factor()

make_html_table(data, col_names = c("Year", "Season", "Region", "Abundance"))
```

#### Survey data (swept area estimates)
```{r, swept_abun_data}
data <- swept_data %>%
  dplyr::select(YEAR, tot.abundance, tot.abund.SE) %>%
  dplyr::mutate(YEAR = as.numeric(YEAR),
                tot.abundance = tot.abundance %>%
                  format(big.mark = ","),
                tot.abund.SE = tot.abund.SE %>%
                  round(digits = 1) %>%
                  format(big.mark = ","))

make_html_table(data, col_names = c("Year", "Abundance", "Standard error"))
```

#### Assessment data
```{r, asmt_abun_data}
data <- asmt_data %>% 
                dplyr::filter(Metric == "Abundance") %>%
                dplyr::select(-Species, -Metric) %>%
                dplyr::mutate(Value = Value %>%
                                round(digits = 0)) %>%
                dplyr::mutate(Value = Value %>%
                              format(big.mark = ",")) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

<!--chapter:end:13-abundance.Rmd-->

```{r, biomass_functions, cache = params$cache}
source(here::here("R/full_report_functions", "get_assessment.R"))
source(here::here("R/full_report_functions", "get_survdat_info.R"))
source(here::here("R/full_report_functions", "get_swept.R"))
```

```{r, biomass_raw_data}
survey_data <- params$survey_data[params$survey_data$Species == species, ]

asmt_data <- params$asmt_data[params$asmt_data$Species == species, ]

swept_data <-  params$swept_data[ params$swept_data$Species == species, ]
```

```{r, child = here::here("bookdown", "_legend-child-doc.Rmd")}
```

## Biomass

Biomass data were pulled from ``r params$survey_source``. 

### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.

#### Survey biomass (raw measurements)
```{r, biomass}
generate_plot(survey_data,
              variable = "BIOMASS", 
              ytitle = "Biomass")
```

##### Risk {-}

See Methods for risk calculation details.
```{r}
indicators <- c("biomass_spring", 
                "biomass_fall")
```

```{r, child = here::here("bookdown", "_risk-child-doc.Rmd")}
```

#### Survey biomass (swept area estimates)

Please note, these estimates are not parsed by region or season. Swept area estimates are based on spring and fall surveys only. The shaded gray region indicates +/- two standard errors.
```{r, bio_survey_swept}
plot_swept(swept_data, var = "biomass")
```

#### Assessment biomass
```{r}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Biomass")) > 0){
ndesc <- asmt_data %>% 
  dplyr::filter(Metric == "Biomass") %>% 
  #dplyr::mutate(options = paste(Description, Units)) %>%
  dplyr::select(Age) %>% 
  unique() %>% 
  nrow()
} else ndesc <- 1
```

```{r, biomass_asmt,  fig.height = ndesc * 4 + 1}
plot_asmt(asmt_data, 
          metric = "Biomass", 
          ytitle = "Biomass",
          lin = lines, 
          col = colors)
```

##### Risk {-}

See Methods for risk calculation details.
```{r}
indicators <- c("asmt_biomass")
```

```{r, child = here::here("bookdown", "_risk-child-doc.Rmd")}
```

### Survey summary
```{r, biomass_summary}
generate_table(survey_data,
              variable = "BIOMASS", 
              cap = "Measured biomass")
```

### Data

#### Survey data (raw measurements)
```{r, biomass_data}
data <- survey_data %>% 
  get_var_data(variable = "BIOMASS") %>%
  dplyr::mutate(variable = variable %>%
                     format(big.mark = ",")) %>%
  character_to_factor()

make_html_table(data, col_names = c("Year", "Season", "Region", "Biomass"))
```

#### Survey data (swept area estimates)
```{r, swept_biomass_data}
data <- swept_data %>%
  dplyr::select(YEAR, tot.biomass, tot.bio.SE) %>%
  dplyr::mutate(YEAR = as.numeric(YEAR),
                tot.biomass = tot.biomass %>%
                  format(big.mark = ","),
                tot.bio.SE = tot.bio.SE %>%
                  round(digits = 1) %>%
                  format(big.mark = ","))

make_html_table(data, col_names = c("Year", "Biomass (kg)", "Standard error"))
```

#### Assessment data
```{r, asmt_biomass_data}
data <- asmt_data %>%
  dplyr::filter(Metric == "Biomass") %>%
  dplyr::select(-Species, -Metric) %>%
  dplyr::mutate(Value = Value %>%
                  round(digits = 0)) %>%
  dplyr::mutate(Value = Value %>%
                  format(big.mark = ",")) %>%
  character_to_factor()

make_html_table(data, col_names = colnames(data))
```

<!--chapter:end:14-biomass.Rmd-->



## B/Bmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:15-bbmsy.Rmd-->



## Recruitment
### Figure
##### Risk
### Data

<!--chapter:end:16-recruitment.Rmd-->

# Socio-economic information

<!--chapter:end:17-socio-economic-title-page.Rmd-->



## Catch
### Figures
#### Stock assessment catch
##### Risk {-}
#### Recreational catch
##### Risk {-}
#### Commercial catch
##### Risk {-}
#### Commercial vs recreational catch
### Data
#### Stock assessment catch
#### Recreational catch
#### Commercial catch
#### Commercial vs recreational catch
#### Commercial, recreational, and stock assessment catch

<!--chapter:end:18-catch.Rmd-->



## F/Fmsy 
### Figure
##### Risk {-}
### Data

<!--chapter:end:19-ffmsy.Rmd-->



## Revenue 
### Figure
##### Risk {-}
### Data

<!--chapter:end:20-revenue.Rmd-->


# Management information

Placeholder


## Stock assessment and data quality information

<!--chapter:end:21-management.Rmd-->


# Risk assessment

Placeholder


## Preliminary risk calculation
### Relative to all other stocks
### Within each stock
## Preliminary risk visualization
### Relative to all other stocks
### Within a single stock

<!--chapter:end:22-risk-assessment.Rmd-->

