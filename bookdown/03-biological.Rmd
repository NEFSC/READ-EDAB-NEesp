# Biological information

```{r, biological_functions, include = FALSE}
source(here::here("R/full_report_functions", "get_length.R"))
source(here::here("R/full_report_functions", "get_lw.R"))
source(here::here("R/full_report_functions", "get_relative_weight.R"))
source(here::here("R/full_report_functions", "get_diet.R"))
```

```{r, biological_data, include = FALSE}
# length data (survdat) already read in with habitat data
survey_data <- params$survey_data
survey_data <- survey_data[survey_data$Species == species, ]

cond_data <- params$cond_data
cond_data <- cond_data[cond_data$Species == species, ]

diet_data <- params$diet_data
diet_data <- diet_data[diet_data$Species == species, ]
```

## Length

Length data were pulled from ``r params$survey_source``. Only years with more than 10 fish lengths were considered for analysis. 

### Figures

Separate geom_gls() functions were fit for the minimum, mean, and maximum lengths; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than three trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, length}
if(sum(is.na(survey_data$LENGTH)) < length(survey_data$LENGTH)){
  generate_len_plot(survey_data)
} else print("NO DATA")
```

### Summary
```{r, length_summary}
if(sum(is.na(survey_data$LENGTH)) < length(survey_data$LENGTH)){
  generate_len_table(survey_data)
} else print("NO DATA")
```

### Data
```{r, length_data}
data <- get_len_data2(survey_data) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", "Number of fish",
                       "Mean length", "Minimum length", "Maximum length"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

## Condition
Condition information comes from [diet data](https://github.com/Laurels1/Condition/blob/master/data/allfh.RData); only regions and seasons with more than 10 fish observations were considered. We calculated a rough condition factor as: Weight / Length^3, and relative weight was [previously calculated](https://github.com/Laurels1/Condition/tree/master/data).

### Figures

#### Length vs weight

Please note, no trend lines were fit, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, lw}
if(length(diet_data$Species) >= 1){
plot_lw(diet_data)
} else print("NO DATA")
```

#### Condition factor: Weight-volume

If there were more than 30 years of data, a geom_gls() regression was fit. In order to fit the geom_gls() regression, we calculated the mean condition factor for each year and plotted the geom_gls() through those points. Please note, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, condition}
if(length(diet_data$Species) >= 1){
plot_cond(diet_data)
} else print("NO DATA")
```

#### Condition factor: Relative weight

Please note, this data is aggregated by Ecological Protection Unit (EPU), which may differ slightly from the stock assessment regions.
```{r, laurel_cond}
if(length(cond_data$Species) >= 1){
plot_relw(cond_data)
} else print("NO DATA")
```

### Data

#### Length vs weight with weight-volume condition factor
```{r, lw_data}
data <- diet_data %>%
  dplyr::filter(is.na(pdlen) == FALSE, 
                  is.na(pdwgt) == FALSE) %>%
  dplyr::select(pdlen, pdwgt, season, Region, fish_id, year) %>%
  dplyr::distinct() %>% # remove duplicates
  dplyr::group_by(Region, season) %>%
  dplyr::mutate(n_fish = length(pdlen)) %>%
  dplyr::filter(n_fish > 10) %>% # only region-season with >10 fish)
  dplyr::mutate(condition = pdwgt/(pdlen^3)) %>%
  dplyr::mutate(condition = condition %>%
                  round(digits = 4)) %>%
  dplyr::select(Region, year, season, pdlen, pdwgt, condition) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Region", "Year", "Season", "Fish length (cm)", 
                       "Fish weight (g)", "Condition (g/cm^3)"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Relative weight condition factor
Please note, this data is aggregated by Ecological Protection Unit (EPU), which may differ slightly from the stock assessment regions.
```{r, laurel_cond_data}
data <- cond_data %>%
  dplyr::select(-Species, -n) %>%
  dplyr::mutate(MeanCond = MeanCond %>%
                  round(digits = 1)) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("EPU", "Fish sex", "Year", "Mean condition",
                       "Number of fish"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```
