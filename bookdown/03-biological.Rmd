# Biological information

```{r, biological_functions, include = FALSE}
source(here::here("R/rank_species_indicators", "plot_risk_by_year.R"))
source(here::here("R/full_report_functions", "get_length.R"))
source(here::here("R/full_report_functions", "get_lw.R"))
source(here::here("R/full_report_functions", "get_relative_weight.R"))
source(here::here("R/full_report_functions", "get_diet.R"))
```

```{r, biological_data, include = FALSE}
# length data (survdat) already read in with habitat data
survey_data <- params$survey_data
survey_data <- survey_data[survey_data$Species == species, ]

cond_data <- params$cond_data
cond_data <- cond_data[cond_data$Species == species, ]

diet_data <- params$diet_data
diet_data <- diet_data[diet_data$Species == species, ]

risk_year_data <- params$risk_year_data
risk_year_data <- risk_year_data[risk_year_data$Species == species, ]
```

## Length

Length data were pulled from ``r params$survey_source``. Only years with more than 10 fish lengths were considered for analysis. 

### Figures

Separate geom_gls() functions were fit for the minimum, mean, and maximum lengths; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than three trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, length}
generate_len_plot(survey_data)
```

#### Risk

Risk was calculated over time for all indicators that were documented for five or more species in a given year. Risk was calculated as the average of the past 5 years, as a percent of the historical average. The normalized risk value plotted here reflects the normalized rank of this species compared to all other species in that year.
```{r}
indicators <- c("max_length_spring",
               "max_length_fall",
               "avg_length_spring",
               "avg_length_fall")
```

```{r, length_risk, fig.height = length(indicators)}
plot_risk_by_year(risk_year_data,
                  indicator = indicators)
```


### Summary
```{r, length_summary}
generate_len_table(survey_data)
```

### Data
```{r, length_data}
data <- get_len_data2(survey_data) %>%
  character_to_factor()

make_html_table(data, col_names = c("Year", "Season", "Region", "Number of fish",
                       "Mean length", "Minimum length", "Maximum length"))
```

## Condition
Condition information comes from [diet data](https://github.com/Laurels1/Condition/blob/master/data/allfh.RData); only regions and seasons with more than 10 fish observations were considered. We calculated a rough condition factor as: Weight / Length^3, and relative weight was [previously calculated](https://github.com/Laurels1/Condition/tree/master/data).

### Figures

#### Length vs weight

Please note, no trend lines were fit, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, lw}
plot_lw(diet_data)
```

#### Condition factor: Weight-volume

If there were more than 30 years of data, a geom_gls() regression was fit. In order to fit the geom_gls() regression, we calculated the mean condition factor for each year and plotted the geom_gls() through those points. Please note, points are jittered to reduce overlap, and sometimes the survey observed a small number of fish outside of the defined stock area.
```{r, condition}
plot_cond(diet_data)
```

#### Condition factor: Relative weight

Please note, this data is aggregated by Ecological Protection Unit (EPU), which may differ slightly from the stock assessment regions.
```{r, laurel_cond}
plot_relw(cond_data)
```

### Data

#### Length vs weight with weight-volume condition factor
```{r, lw_data}
data <- diet_data %>%
  dplyr::filter(is.na(pdlen) == FALSE, 
                  is.na(pdwgt) == FALSE) %>%
  dplyr::select(pdlen, pdwgt, season, Region, fish_id, year) %>%
  dplyr::distinct() %>% # remove duplicates
  dplyr::group_by(Region, season) %>%
  dplyr::mutate(n_fish = length(pdlen)) %>%
  dplyr::filter(n_fish > 10) %>% # only region-season with >10 fish)
  dplyr::mutate(condition = pdwgt/(pdlen^3)) %>%
  dplyr::mutate(condition = condition %>%
                  round(digits = 4)) %>%
  dplyr::select(Region, year, season, pdlen, pdwgt, condition) %>%
  character_to_factor()

make_html_table(data, col_names = c("Region", "Year", "Season", "Fish length (cm)", 
                       "Fish weight (g)", "Condition (g/cm^3)"))
```

#### Relative weight condition factor
Please note, this data is aggregated by Ecological Protection Unit (EPU), which may differ slightly from the stock assessment regions.
```{r, laurel_cond_data}
data <- cond_data %>%
  dplyr::select(-Species, -n) %>%
  dplyr::mutate(MeanCond = MeanCond %>%
                  round(digits = 1)) %>%
  character_to_factor()

make_html_table(data, col_names = c("EPU", "Fish sex", "Year", "Mean condition",
                       "Number of fish"))
```

## Diet
Diet data were compiled from [existing data](https://github.com/Laurels1/Condition/blob/master/data/allfh.RData). For analysis, all geographic samples were grouped by season, year, and region, and only year-season-region combinations with more than 20 predators sampled were considered. Prey items that made up more than 5% of the predator's diet in at least one year-season-region were identified to the broad category level; all other prey are grouped into the "other" category.

### Figure
```{r, diet}
get_diet_plot(data = diet_data)
```

### Summary
```{r, diet_summary}
get_diet_table(data = diet_data)
```

### Data
```{r, diet_data}
diet_data2 <- diet_data %>%
    dplyr::filter(pyamtw > 0) %>%
    
    # only look at season/year combinations with >20 predator samples
    dplyr::group_by(year, season, Region) %>%
    dplyr::mutate(n_predators = fish_id %>% unique() %>% length()) %>%
    dplyr::filter(n_predators > 20) %>%
    dplyr::group_by(year, season, Region, n_predators, gensci) %>%
    dplyr::summarise(total_weight = sum(pyamtw)) %>%
    dplyr::mutate(proportion = total_weight/sum(total_weight),
                  proportion = proportion %>%
                    round(digits = 3),
                  total_weight = total_weight %>%
                    round(digits = 2),
                  gensci = gensci %>% 
                    stringr::str_replace("_", " ") %>%
                    stringr::str_to_sentence())  %>%
  character_to_factor()

make_html_table(diet_data2, col_names = c("Year", "Season", "Region", "Number of fish", 
                       "Prey category", "Prey weight", "Prey proportion"))
```