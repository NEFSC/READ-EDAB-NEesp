# Population information

```{r, pop_functions, include = FALSE}
source(here::here("R/full_report_functions", "get_bf.R"))
source(here::here("R/full_report_functions", "get_assessment.R"))
source(here::here("R/full_report_functions", "get_swept.R"))
```

```{r, pop_data, include = FALSE}
# abun/biomass data (survdat) already read in with habitat data
survey_data <- params$survey_data
survey_data <- survey_data[survey_data$Species == species, ]

asmt_sum_data <- params$asmt_sum_data
asmt_sum_data <- asmt_sum_data[asmt_sum_data$Species == species, ]

asmt_data <- params$asmt_data
asmt_data <- asmt_data[asmt_data$Species == species, ]

swept_data <- params$swept_data
swept_data <- swept_data[swept_data$Species == species, ]
```

```{r, b_status}
if(length(asmt_sum_data$Species) > 1){
  list_regions <- split(unique(asmt_sum_data$Region), 
                        f = list(unique(asmt_sum_data$Region)))
  bbmsy2 <- purrr::map(list_regions, 
                       ~status(data = asmt_sum_data, 
                               regions = .x, 
                               metric = "bbmsy"))
} else bbmsy2 <- "UNKNOWN"

```

```{r, legend}
# set colors and linetypes to be constant for all regions
reg <- c(asmt_sum_data$Region, asmt_data$Region) %>% unique()

lines <- 1:length(reg)
names(lines) <- reg

colors <- nmfspalette::nmfs_palette("regional web")(length(reg))
names(colors) <- reg

```

## Abundance

Abundance data were pulled from ``r params$survey_source`` and ``r params$asmt_source``. 

### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.

#### Survey abundance (raw measurements)
```{r, abun_survey}
if(sum(is.na(survey_data$ABUNDANCE)) < length(survey_data$ABUNDANCE)){
  generate_plot(survey_data,
              variable = "ABUNDANCE", 
              ytitle = "Abundance")
} else print("NO DATA")
```

#### Survey abundance (swept area estimates)

Please note, these estimates are not parsed by region or season. Swept area estimates are based on spring and fall surveys only. The shaded gray region indicates +/- two standard errors.
```{r, abun_survey_swept}
if(nrow(swept_data) > 0){
  plot_swept_abun(swept_data)
} else print("NO DATA")
```

#### Assessment abundance
```{r, abun_asmt}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Abundance")) > 0){
plot_asmt(asmt_data, 
          metric = "Abundance", 
          ytitle = "Abundance",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

### Survey summary
```{r, abun_summary}
if(sum(is.na(survey_data$ABUNDANCE)) < length(survey_data$ABUNDANCE)){
  generate_table(survey_data,
              variable = "ABUNDANCE", 
              cap = "Measured abundance")
} else print("NO DATA")
```

### Data

#### Survey data (raw measurements)
```{r, surv_abun_data}
data <- get_var_data(survey_data, variable = "ABUNDANCE") %>%
  dplyr::mutate(variable = variable %>%
                  format(big.mark = ","))  %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", "Abundance"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Survey data (swept area estimates)
```{r, swept_abun_data}
data <- swept_data %>%
  dplyr::select(YEAR, tot.abundance, tot.abund.SE) %>%
  dplyr::mutate(YEAR = as.numeric(YEAR),
                tot.abundance = tot.abundance %>%
                  format(big.mark = ","),
                tot.abund.SE = tot.abund.SE %>%
                  round(digits = 1) %>%
                  format(big.mark = ","))

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Abundance", "Standard error"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Assessment data
```{r, asmt_abun_data}
data <- asmt_data %>% 
                dplyr::filter(Metric == "Abundance") %>%
                dplyr::select(-Species, -Metric) %>%
                dplyr::mutate(Value = Value %>%
                              format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

## Biomass

Biomass data were pulled from ``r params$survey_source``. 

### Figures

Separate geom_gls() functions were fit for fall and spring measurements; trend lines are only shown when the trend was statistically significant, so some plots may have fewer than two trend lines. Fall has solid trend lines, and spring has dashed trend lines. Please note, sometimes the survey observed a small number of fish outside of the defined stock area.

#### Survey biomass (raw measurements)
```{r, biomass}
if(sum(is.na(survey_data$BIOMASS)) < length(survey_data$BIOMASS)){
  generate_plot(survey_data,
              variable = "BIOMASS", 
              ytitle = "Biomass")
} else print("NO DATA")
```

#### Survey biomass (swept area estimates)

Please note, these estimates are not parsed by region or season. Swept area estimates are based on spring and fall surveys only. The shaded gray region indicates +/- two standard errors.
```{r, bio_survey_swept}
if(nrow(swept_data) > 0){
  plot_swept_biomass(swept_data)
} else print("NO DATA")
```

#### Assessment biomass:
```{r, biomass_asmt}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Biomass")) > 0){
plot_asmt(asmt_data, 
          metric = "Biomass", 
          ytitle = "Biomass",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

### Summary
```{r, biomass_summary}
if(sum(is.na(survey_data$BIOMASS)) < length(survey_data$BIOMASS)){
  generate_table(survey_data,
              variable = "BIOMASS", 
              cap = "Measured biomass")
} else print("NO DATA")
```

### Data

#### Survey data (raw measurements)
```{r, biomass_data}
data <- survey_data %>% 
  dplyr::group_by(YEAR, SEASON, Region, date, fish_id) %>%
  dplyr::distinct() %>% # remove repeated row info
  dplyr::ungroup() %>%
  dplyr::group_by(YEAR, SEASON, Region) %>% # re-group
  dplyr::summarise(Biomass = sum(BIOMASS) %>%
                     format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Season", "Region", "Biomass"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Survey data (swept area estimates)
```{r, swept_biomass_data}
data <- swept_data %>%
  dplyr::select(YEAR, tot.biomass, tot.bio.SE) %>%
  dplyr::mutate(YEAR = as.numeric(YEAR),
                tot.biomass = tot.biomass %>%
                  format(big.mark = ","),
                tot.bio.SE = tot.bio.SE %>%
                  round(digits = 1) %>%
                  format(big.mark = ","))

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Biomass (kg)", "Standard error"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Assessment data
```{r, asmt_biomass_data}
data <- asmt_data %>% 
                dplyr::filter(Metric == "Biomass") %>%
                dplyr::select(-Species, -Metric) %>%
                dplyr::mutate(Value = Value %>%
                              format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

## B/Bmsy 

B/Bmsy data were pulled from ``r params$asmt_sum_source``.

The most recent status of B/Bmsy is: `r bbmsy2`

### Figure
```{r, bbmsy_fig} 
if("GOOD" %in% bbmsy2 | "DANGER" %in% bbmsy2){
  plot_bbmsy(asmt_sum_data[which(is.na(asmt_sum_data$B.Bmsy) == FALSE), ], 
             ytitle = "B / Bmsy",
             lin = lines,
             col = colors)
} else print("NO DATA")
```

### Data
```{r, bbmsy_data}
data <- asmt_sum_data[which(is.na(asmt_sum_data$B.Bmsy) == FALSE), ] %>% 
                dplyr::select(Region, B.Year, B.Bmsy) %>%
                dplyr::mutate(B.Bmsy = B.Bmsy %>% round(digits = 2)) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Region", "Year", "B/Bmsy"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

## Recruitment {.tabset .tabset-fade .tabset-pills}
Recruitment data were pulled from ``r params$asmt_source``. Separate geom_gls() functions were fit for each region; trend lines are only shown when the trend was statistically significant, so some plots may have fewer trend lines than regions.

### Figure
```{r, recruitment}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Recruitment")) > 0){
plot_asmt(asmt_data, 
          metric = "Recruitment", 
          ytitle = "Recruitment",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

### Data
```{r, recruit_data}
data <- asmt_data %>% 
                dplyr::filter(Metric == "Recruitment") %>%
                dplyr::select(-Species, -Metric) %>%
                dplyr::mutate(Value = Value %>%
                              format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

