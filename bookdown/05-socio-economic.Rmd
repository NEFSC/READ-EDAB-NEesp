# Socio-economic information

```{r, soceco_functions, include = FALSE}
# already run in pop section
#source(here::here("R/full_report_functions", "get_bf.R")) 
#source(here::here("R/full_report_functions", "get_assessment.R"))
source(here::here("R/full_report_functions", "get_rec_catch.R"))
source(here::here("R/full_report_functions", "get_com_catch.R"))
source(here::here("R/full_report_functions", "get_com_money.R"))
source(here::here("R/full_report_functions", "compare_rec_com.R"))
```

```{r, soceco_data, include = FALSE}
# assessment data read in with pop data
#asmt_sum_data <- params$asmt_sum_data
#asmt_sum_data <- asmt_sum_data[asmt_sum_data$Species == species, ]

#asmt_data <- params$asmt_data
#asmt_data <- asmt_data[asmt_data$Species == species, ]

rec_data <- params$rec_data
rec_data <- rec_data[rec_data$Species == species, ]

com_data <- params$com_data
com_data <- com_data[com_data$Species == species, ]
```

```{r, f_status}
if(length(asmt_sum_data$Species) > 1){
  list_regions <- split(unique(asmt_sum_data$Region), 
                        f = list(unique(asmt_sum_data$Region)))
  ffmsy2 <- purrr::map(list_regions, 
                       ~status(data = asmt_sum_data, 
                               regions = .x, 
                               metric = "ffmsy"))
} else ffmsy2 <- "UNKNOWN"

```

```{r, legend2, eval = FALSE}
# already run in pop section
# set colors and linetypes to be constant for all regions
reg <- c(asmt_sum_data$Region, asmt_data$Region) %>% unique()

lines <- 1:length(reg)
names(lines) <- reg

colors <- nmfspalette::nmfs_palette("regional web")(length(reg))
names(colors) <- reg

```

## Catch

Stock assessment catch data are from ``r params$asmt_source``. Recreational catch data were downloaded from [NOAA MRIP](https://www.st.nmfs.noaa.gov/st1/recreational/MRIP_Estimate_Data/CSV/). Commercial catch data were downloaded from [NOAA FOSS](https://foss.nmfs.noaa.gov/apexfoss/f?p=215:200:4615327020711::NO:::).

### Figures
```{r}
if(nrow(asmt_data %>% dplyr::filter(Metric == "Catch")) > 0){
ndesc <- asmt_data %>% 
  dplyr::filter(Metric == "Catch") %>% 
  dplyr::mutate(options = paste(Description, Units)) %>%
  dplyr::select(options) %>% 
  unique() %>% 
  length()
} else ndesc <- 1
```

#### Stock assessment catch
```{r, catch, fig.height = ndesc * 10} 
if(nrow(asmt_data %>% dplyr::filter(Metric == "Catch")) > 0){
plot_asmt(asmt_data, 
          metric = "Catch", 
          ytitle = "Catch",
          lin = lines, 
          col = colors)
} else print("NO DATA")
```

#### Recreational catch
```{r, rec}
if(length(rec_data$Species) > 0){
  get_rec_catch(rec_data)
} else print("NO DATA")
```

#### Commercial catch
```{r, com}
if(length(com_data$Species) > 0){
  plot_com(com_data)
} else print("NO DATA")
```

#### Commercial vs recreational catch
```{r, comvrec}
if(length(com_data$Species) > 0 & length(rec_data$Species) > 0){
  prop_catch(com = com_data, rec = rec_data)
} else print("NO DATA")
```

### Data

#### Stock assessment catch
```{r, catch_data}
data <- asmt_data %>% 
  dplyr::filter(Metric == "Catch") %>%
  dplyr::select(-Species, -Metric) %>%
  dplyr::mutate(Value = Value %>%
                  format(big.mark = ",")) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Recreational catch
```{r, rec_data}
data <- rec_data %>% 
  dplyr::select(year, st_f, mode_fx_f, tot_cat) %>%
  dplyr::mutate(State = st_f %>%
                  stringr::str_to_title(),
                Method = mode_fx_f %>% 
                  stringr::str_to_sentence(),
                Catch_pounds = tot_cat %>%
                  format(big.mark = ",")) %>%
  dplyr::select(year, State, Method, Catch_pounds) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "State", "Method", "Catch (lb)"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Commercial catch
```{r, com_data}
data <- com_data %>% 
                dplyr::select(Year, State, Dollars_adj, Pounds) %>%
                dplyr::mutate(Dollars_adj = Dollars_adj %>% 
                                round(digits = 0) %>%
                                format(big.mark = ","),
                              State = State %>% 
                                stringr::str_to_title(),
                              Pounds = Pounds %>%
                                format(big.mark = ",")) %>%
                dplyr::rename("Revenue (2019 dollars)" = "Dollars_adj",
                              "Commercial catch (lb)" = "Pounds") %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Commercial vs recreational catch
```{r, comvrec_data}
data <- prop_catch_data(rec = rec_data, com = com_data) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          colnames = c("Year", "Recreational catch", "Commercial catch",
                       "Total catch", "Proportion recreational",
                       "Proportion commercial"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

#### Commercial, recreational, and stock assessment catch
```{r, all_catch}
stock <- asmt_data %>%
  dplyr::filter(Metric == "Catch",
                Region != "Eastern Georges Bank") %>% # double counted
  dplyr::mutate(options = paste(Description, Units, sep = " - ")) %>%
  dplyr::group_by(Year, options) %>%
  dplyr::summarise(Value = sum(Value)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = options,
                     values_from = Value)

recr <- rec_data %>%
  dplyr::group_by(year) %>%
  dplyr::rename(Year = year) %>%
  dplyr::summarise(`Recreational catch (mt)` = sum(tot_cat)/2204.6)

comm <- com_data %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(`Commercial catch (mt)` = sum(Pounds)/2204.6)

all_catch <- dplyr::full_join(stock, recr, by = "Year")
all_catch <- dplyr::full_join(all_catch, comm, by = "Year") %>%
  dplyr::arrange(Year) %>%
  round(digits = 0) %>%
  #format(big.mark = ",") %>% # messing up formatting
  as.data.frame()

DT::datatable(all_catch, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))

```


## F/Fmsy 

F/Fmsy data were pulled from ``r params$asmt_sum_source``.

The most recent status of F/Fmsy is: `r ffmsy2`

### Figure
```{r, ffmsy}
if("GOOD" %in% ffmsy2 | "DANGER" %in% ffmsy2){
 plot_ffmsy(asmt_sum_data[which(is.na(asmt_sum_data$F.Fmsy) == FALSE), ],
                      ytitle = "F / Fmsy",
             lin = lines,
             col = colors)
} else print("NO DATA")
```

### Data
```{r, ffmsy_data}
data <- asmt_sum_data[which(is.na(asmt_sum_data$F.Fmsy) == FALSE), ] %>% 
                dplyr::select(Region, F.Year, F.Fmsy) %>%
                dplyr::mutate(F.Fmsy = F.Fmsy %>% round(digits = 2)) %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
                    colnames = c("Region", "Year", "F/Fmsy"),
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```

## Revenue 

Commercial catch data were downloaded from [NOAA FOSS](https://foss.nmfs.noaa.gov/apexfoss/f?p=215:200:4615327020711::NO:::).

### Figure
```{r, revenue}
if(length(com_data$Species) > 0){
  plot_com_money(com_data)
} else print("NO DATA")
```

### Data
```{r, revenue_data}
data <- com_data %>% 
                dplyr::select(Year, State, Dollars_adj, Pounds) %>%
                dplyr::mutate(Dollars_adj = Dollars_adj %>% 
                                round(digits = 0) %>%
                                format(big.mark = ","),
                              State = State %>% 
                                stringr::str_to_title(),
                              Pounds = Pounds %>%
                                format(big.mark = ",")) %>%
                dplyr::rename("Revenue (2019 dollars)" = "Dollars_adj",
                              "Commercial catch (lb)" = "Pounds") %>%
  character_to_factor()

DT::datatable(data, 
          rownames = FALSE,
          filter = list(position = 'top', 
                        clear = FALSE),
          extensions = 'Scroller',
          options = list(search = list(regex = TRUE),
                         deferRender = TRUE,
                         scrollY = 200,
                         scrollX = TRUE,
                         scroller = TRUE,
                         language = list(thousands = ",")))
```
